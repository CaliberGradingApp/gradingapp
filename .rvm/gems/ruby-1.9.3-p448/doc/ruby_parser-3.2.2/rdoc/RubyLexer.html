<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>class RubyLexer - ruby_parser-3.2.2 Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="class">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/ruby_lexer.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    <nav id="parent-class-section" class="section">
  <h3 class="section-header">Parent</h3>
  
  <p class="link">Object
  
</nav>

    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-new">::new</a>
    
    <li><a href="#method-i-advance">#advance</a>
    
    <li><a href="#method-i-arg_ambiguous">#arg_ambiguous</a>
    
    <li><a href="#method-i-comments">#comments</a>
    
    <li><a href="#method-i-expr_beg_push">#expr_beg_push</a>
    
    <li><a href="#method-i-fix_arg_lex_state">#fix_arg_lex_state</a>
    
    <li><a href="#method-i-heredoc">#heredoc</a>
    
    <li><a href="#method-i-heredoc_identifier">#heredoc_identifier</a>
    
    <li><a href="#method-i-in_lex_state-3F">#in_lex_state?</a>
    
    <li><a href="#method-i-int_with_base">#int_with_base</a>
    
    <li><a href="#method-i-is_arg-3F">#is_arg?</a>
    
    <li><a href="#method-i-is_beg-3F">#is_beg?</a>
    
    <li><a href="#method-i-is_end-3F">#is_end?</a>
    
    <li><a href="#method-i-is_label_possible-3F">#is_label_possible?</a>
    
    <li><a href="#method-i-is_space_arg-3F">#is_space_arg?</a>
    
    <li><a href="#method-i-lex_state-3D">#lex_state=</a>
    
    <li><a href="#method-i-lineno">#lineno</a>
    
    <li><a href="#method-i-parse_number">#parse_number</a>
    
    <li><a href="#method-i-parse_quote">#parse_quote</a>
    
    <li><a href="#method-i-parse_string">#parse_string</a>
    
    <li><a href="#method-i-process_token">#process_token</a>
    
    <li><a href="#method-i-rb_compile_error">#rb_compile_error</a>
    
    <li><a href="#method-i-read_escape">#read_escape</a>
    
    <li><a href="#method-i-regx_options">#regx_options</a>
    
    <li><a href="#method-i-reset">#reset</a>
    
    <li><a href="#method-i-ruby18">#ruby18</a>
    
    <li><a href="#method-i-ruby19">#ruby19</a>
    
    <li><a href="#method-i-src-3D">#src=</a>
    
    <li><a href="#method-i-tokadd_escape">#tokadd_escape</a>
    
    <li><a href="#method-i-tokadd_string">#tokadd_string</a>
    
    <li><a href="#method-i-unescape">#unescape</a>
    
    <li><a href="#method-i-warning">#warning</a>
    
    <li><a href="#method-i-yylex">#yylex</a>
    
    <li><a href="#method-i-yylex_paren18">#yylex_paren18</a>
    
    <li><a href="#method-i-yylex_paren19">#yylex_paren19</a>
    
    <li><a href="#method-i-yylex_string">#yylex_string</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./History_txt.html">History</a>
  
    <li class="file"><a href="./Manifest_txt.html">Manifest</a>
  
    <li class="file"><a href="./README_txt.html">README</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./RubyParserStuff.html">RubyParserStuff</a>
  
    <li><a href="./RubyParserStuff/Environment.html">RubyParserStuff::Environment</a>
  
    <li><a href="./RubyParserStuff/Keyword.html">RubyParserStuff::Keyword</a>
  
    <li><a href="./RubyParserStuff/Keyword/KWtable.html">RubyParserStuff::Keyword::KWtable</a>
  
    <li><a href="./RubyParserStuff/Ruby18Parser.html">RubyParserStuff::Ruby18Parser</a>
  
    <li><a href="./RubyParserStuff/Ruby19Parser.html">RubyParserStuff::Ruby19Parser</a>
  
    <li><a href="./RubyParserStuff/Ruby20Parser.html">RubyParserStuff::Ruby20Parser</a>
  
    <li><a href="./RubyParserStuff/RubyParser.html">RubyParserStuff::RubyParser</a>
  
    <li><a href="./RubyParserStuff/RubyParser/SyntaxError.html">RubyParserStuff::RubyParser::SyntaxError</a>
  
    <li><a href="./RubyParserStuff/Sexp.html">RubyParserStuff::Sexp</a>
  
    <li><a href="./RubyParserStuff/StackState.html">RubyParserStuff::StackState</a>
  
    <li><a href="./RubyParserStuff/String.html">RubyParserStuff::String</a>
  
    <li><a href="./RPStringScanner.html">RPStringScanner</a>
  
    <li><a href="./Ruby18Parser.html">Ruby18Parser</a>
  
    <li><a href="./Ruby19Parser.html">Ruby19Parser</a>
  
    <li><a href="./Ruby20Parser.html">Ruby20Parser</a>
  
    <li><a href="./RubyLexer.html">RubyLexer</a>
  
    <li><a href="./RubyParserGauntlet.html">RubyParserGauntlet</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="class">class RubyLexer</h1>

  <div id="description" class="description">
    
  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="EOF">EOF
        
        <dd class="description">
        
      
        <dt id="ESCAPES">ESCAPES
        
        <dd class="description">
        
      
      </dl>
    </section>
    

    
    <!-- Attributes -->
    <section id="attribute-method-details" class="method-section section">
      <h3 class="section-header">Attributes</h3>

      
      <div id="attribute-i-brace_nest" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">brace_nest</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-lex_state" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">lex_state</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>Additional context surrounding tokens that both the lexer and grammar use.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-lex_strterm" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">lex_strterm</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-lineno" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">lineno</span><span
            class="attribute-access-type">[W]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-lpar_beg" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">lpar_beg</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-paren_nest" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">paren_nest</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-parser" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">parser</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-space_seen" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">space_seen</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-src" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">src</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        <p>Stream of data that yylex examines.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-string_buffer" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">string_buffer</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-token" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">token</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Last token read via yylex.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-version" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">version</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>What version of ruby to parse. 18 and 19 are the only valid values
currently supported.</p>
        
        </div>
      </div>
      
      <div id="attribute-i-warnings" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">warnings</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>What handles warnings</p>
        
        </div>
      </div>
      
      <div id="attribute-i-yacc_value" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">yacc_value</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Value of last token which had a value associated with it.</p>
        
        </div>
      </div>
      
    </section><!-- attribute-method-details -->
    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(v = 18)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 247</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span> <span class="ruby-identifier">v</span> = <span class="ruby-value">18</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">version</span> = <span class="ruby-identifier">v</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">cond</span>   = <span class="ruby-constant">RubyParserStuff</span><span class="ruby-operator">::</span><span class="ruby-constant">StackState</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:cond</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">cmdarg</span> = <span class="ruby-constant">RubyParserStuff</span><span class="ruby-operator">::</span><span class="ruby-constant">StackState</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:cmdarg</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tern</span>   = <span class="ruby-constant">RubyParserStuff</span><span class="ruby-operator">::</span><span class="ruby-constant">StackState</span>.<span class="ruby-identifier">new</span>(<span class="ruby-value">:tern</span>)
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">string_nest</span> = <span class="ruby-value">0</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">paren_nest</span> = <span class="ruby-value">0</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">brace_nest</span> = <span class="ruby-value">0</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lpar_beg</span> = <span class="ruby-keyword">nil</span>

  <span class="ruby-ivar">@comments</span> = []

  <span class="ruby-identifier">reset</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-advance" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">advance</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>How the parser advances to the next token.</p>

<p>@return true if not at end of file (<a href="RubyLexer.html#EOF">EOF</a>).</p>
          

          
          <div class="method-source-code" id="advance-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 98</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">advance</span>
  <span class="ruby-identifier">r</span> = <span class="ruby-identifier">yylex</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">token</span> = <span class="ruby-identifier">r</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;yylex returned nil&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">r</span>

  <span class="ruby-keyword">return</span> <span class="ruby-constant">RubyLexer</span><span class="ruby-operator">::</span><span class="ruby-constant">EOF</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">r</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- advance-source -->
          
        </div>

        

        
      </div><!-- advance-method -->

    
      <div id="method-i-arg_ambiguous" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">arg_ambiguous</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="arg_ambiguous-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 107</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">arg_ambiguous</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">warning</span>(<span class="ruby-string">&quot;Ambiguous first argument. make sure.&quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- arg_ambiguous-source -->
          
        </div>

        

        
      </div><!-- arg_ambiguous-method -->

    
      <div id="method-i-comments" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">comments</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="comments-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 111</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">comments</span>
  <span class="ruby-identifier">c</span> = <span class="ruby-ivar">@comments</span>.<span class="ruby-identifier">join</span>
  <span class="ruby-ivar">@comments</span>.<span class="ruby-identifier">clear</span>
  <span class="ruby-identifier">c</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- comments-source -->
          
        </div>

        

        
      </div><!-- comments-method -->

    
      <div id="method-i-expr_beg_push" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">expr_beg_push</span><span
            class="method-args">(val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="expr_beg_push-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 117</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">expr_beg_push</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">cond</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">cmdarg</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">val</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- expr_beg_push-source -->
          
        </div>

        

        
      </div><!-- expr_beg_push-method -->

    
      <div id="method-i-fix_arg_lex_state" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">fix_arg_lex_state</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="fix_arg_lex_state-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 124</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">fix_arg_lex_state</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_fname</span>, <span class="ruby-value">:expr_dot</span> <span class="ruby-keyword">then</span>
                     <span class="ruby-value">:expr_arg</span>
                   <span class="ruby-keyword">else</span>
                     <span class="ruby-value">:expr_beg</span>
                   <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- fix_arg_lex_state-source -->
          
        </div>

        

        
      </div><!-- fix_arg_lex_state-method -->

    
      <div id="method-i-heredoc" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">heredoc</span><span
            class="method-args">(here)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="heredoc-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 132</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">heredoc</span> <span class="ruby-identifier">here</span> <span class="ruby-comment"># 63 lines</span>
  <span class="ruby-identifier">_</span>, <span class="ruby-identifier">eos</span>, <span class="ruby-identifier">func</span>, <span class="ruby-identifier">last_line</span> = <span class="ruby-identifier">here</span>

  <span class="ruby-identifier">indent</span>  = (<span class="ruby-identifier">func</span> &amp; <span class="ruby-constant">STR_FUNC_INDENT</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;[ \t]*&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">expand</span>  = (<span class="ruby-identifier">func</span> &amp; <span class="ruby-constant">STR_FUNC_EXPAND</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">eos_re</span>  = <span class="ruby-node">/#{indent}#{Regexp.escape eos}(\r*\n|\z)/</span>
  <span class="ruby-identifier">err_msg</span> = <span class="ruby-node">&quot;can't match #{eos_re.inspect} anywhere in &quot;</span>

  <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-identifier">err_msg</span> <span class="ruby-keyword">if</span>
    <span class="ruby-identifier">src</span>.<span class="ruby-identifier">eos?</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">beginning_of_line?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-identifier">eos_re</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">src</span>.<span class="ruby-identifier">unread_many</span> <span class="ruby-identifier">last_line</span> <span class="ruby-comment"># TODO: figure out how to remove this</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">eos</span>
    <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING_END</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">string_buffer</span> = []

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">expand</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">case</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/#[$@]/</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">src</span>.<span class="ruby-identifier">pos</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span> <span class="ruby-comment"># FIX omg stupid</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
      <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING_DVAR</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/#[{]/</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
      <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING_DBEG</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/#/</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">'#'</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">c</span> = <span class="ruby-identifier">tokadd_string</span> <span class="ruby-identifier">func</span>, <span class="ruby-string">&quot;\n&quot;</span>, <span class="ruby-keyword">nil</span>

      <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-identifier">err_msg</span> <span class="ruby-keyword">if</span>
        <span class="ruby-identifier">c</span> <span class="ruby-operator">==</span> <span class="ruby-constant">RubyLexer</span><span class="ruby-operator">::</span><span class="ruby-constant">EOF</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;\n&quot;</span> <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">string_buffer</span>.<span class="ruby-identifier">join</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">&quot;\r&quot;</span>)
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING_CONTENT</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\n/</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-identifier">err_msg</span> <span class="ruby-keyword">if</span>
        <span class="ruby-identifier">src</span>.<span class="ruby-identifier">eos?</span>
    <span class="ruby-keyword">end</span> <span class="ruby-keyword">until</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-identifier">eos_re</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">until</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-identifier">eos_re</span>) <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/.*(\n|\z)/</span>)
      <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-identifier">err_msg</span> <span class="ruby-keyword">if</span>
        <span class="ruby-identifier">src</span>.<span class="ruby-identifier">eos?</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_strterm</span> = [<span class="ruby-value">:heredoc</span>, <span class="ruby-identifier">eos</span>, <span class="ruby-identifier">func</span>, <span class="ruby-identifier">last_line</span>]
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">string_buffer</span>.<span class="ruby-identifier">join</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">&quot;\r&quot;</span>)

  <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING_CONTENT</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- heredoc-source -->
          
        </div>

        

        
      </div><!-- heredoc-method -->

    
      <div id="method-i-heredoc_identifier" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">heredoc_identifier</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="heredoc_identifier-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 194</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">heredoc_identifier</span> <span class="ruby-comment"># 51 lines</span>
  <span class="ruby-identifier">term</span>, <span class="ruby-identifier">func</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-constant">STR_FUNC_BORING</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">string_buffer</span> = []

  <span class="ruby-keyword">case</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/(-?)([\\&quot;\`])(.*?)\2/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">term</span> = <span class="ruby-identifier">src</span>[<span class="ruby-value">2</span>]
    <span class="ruby-identifier">func</span> <span class="ruby-operator">|=</span> <span class="ruby-constant">STR_FUNC_INDENT</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">src</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">func</span> <span class="ruby-operator">|=</span> <span class="ruby-keyword">case</span> <span class="ruby-identifier">term</span>
            <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;\'&quot;</span> <span class="ruby-keyword">then</span>
              <span class="ruby-constant">STR_SQUOTE</span>
            <span class="ruby-keyword">when</span> <span class="ruby-string">'&quot;'</span> <span class="ruby-keyword">then</span>
              <span class="ruby-constant">STR_DQUOTE</span>
            <span class="ruby-keyword">else</span>
              <span class="ruby-constant">STR_XQUOTE</span>
            <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>[<span class="ruby-value">3</span>]
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/-?([\\&quot;\`])(?!\1*\Z)/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;unterminated here document identifier&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/(-?)(#{IDENT_CHAR_RE}+)/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">term</span> = <span class="ruby-string">'&quot;'</span>
    <span class="ruby-identifier">func</span> <span class="ruby-operator">|=</span> <span class="ruby-constant">STR_DQUOTE</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">src</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">empty?</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">func</span> <span class="ruby-operator">|=</span> <span class="ruby-constant">STR_FUNC_INDENT</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>[<span class="ruby-value">2</span>]
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/.*\n/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-comment"># TODO: think about storing off the char range instead</span>
    <span class="ruby-identifier">line</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
    <span class="ruby-identifier">src</span>.<span class="ruby-identifier">extra_lines_added</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">line</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_strterm</span> = [<span class="ruby-value">:heredoc</span>, <span class="ruby-identifier">string_buffer</span>.<span class="ruby-identifier">join</span>, <span class="ruby-identifier">func</span>, <span class="ruby-identifier">line</span>]

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">term</span> <span class="ruby-operator">==</span> <span class="ruby-string">'`'</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;`&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-value">:tXSTRING_BEG</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;\&quot;&quot;</span>
    <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING_BEG</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- heredoc_identifier-source -->
          
        </div>

        

        
      </div><!-- heredoc_identifier-method -->

    
      <div id="method-i-in_lex_state-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">in_lex_state?</span><span
            class="method-args">(*states)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="in_lex_state-3F-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 243</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">in_lex_state?</span>(*<span class="ruby-identifier">states</span>)
  <span class="ruby-identifier">states</span>.<span class="ruby-identifier">include?</span> <span class="ruby-identifier">lex_state</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- in_lex_state-3F-source -->
          
        </div>

        

        
      </div><!-- in_lex_state-3F-method -->

    
      <div id="method-i-int_with_base" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">int_with_base</span><span
            class="method-args">(base)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="int_with_base-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 262</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">int_with_base</span> <span class="ruby-identifier">base</span>
  <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;Invalid numeric format&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/__/</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>.<span class="ruby-identifier">to_i</span>(<span class="ruby-identifier">base</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-value">:tINTEGER</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- int_with_base-source -->
          
        </div>

        

        
      </div><!-- int_with_base-method -->

    
      <div id="method-i-is_arg-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_arg?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="is_arg-3F-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 1363</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_arg?</span>
  <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_arg</span>, <span class="ruby-value">:expr_cmdarg</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_arg-3F-source -->
          
        </div>

        

        
      </div><!-- is_arg-3F-method -->

    
      <div id="method-i-is_beg-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_beg?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="is_beg-3F-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 1371</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_beg?</span>
  <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_beg</span>, <span class="ruby-value">:expr_value</span>, <span class="ruby-value">:expr_mid</span>, <span class="ruby-value">:expr_class</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_beg-3F-source -->
          
        </div>

        

        
      </div><!-- is_beg-3F-method -->

    
      <div id="method-i-is_end-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_end?</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="is_end-3F-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 1367</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_end?</span>
  <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_end</span>, <span class="ruby-value">:expr_endarg</span>, <span class="ruby-value">:expr_endfn</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_end-3F-source -->
          
        </div>

        

        
      </div><!-- is_end-3F-method -->

    
      <div id="method-i-is_label_possible-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_label_possible?</span><span
            class="method-args">(command_state)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="is_label_possible-3F-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 1381</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_label_possible?</span> <span class="ruby-identifier">command_state</span>
  (<span class="ruby-identifier">in_lex_state?</span>(<span class="ruby-value">:expr_beg</span>) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">command_state</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">is_arg?</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_label_possible-3F-source -->
          
        </div>

        

        
      </div><!-- is_label_possible-3F-method -->

    
      <div id="method-i-is_space_arg-3F" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">is_space_arg?</span><span
            class="method-args">(c = "x")</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>TODO define IS_AFTER_OPERATOR() IS_lex_state(EXPR_FNAME | EXPR_DOT)</p>
          

          
          <div class="method-source-code" id="is_space_arg-3F-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 1377</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">is_space_arg?</span> <span class="ruby-identifier">c</span> = <span class="ruby-string">&quot;x&quot;</span>
  <span class="ruby-identifier">is_arg?</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">space_seen</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">!~</span> <span class="ruby-regexp">/\s/</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- is_space_arg-3F-source -->
          
        </div>

        

        
      </div><!-- is_space_arg-3F-method -->

    
      <div id="method-i-lex_state-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">lex_state=</span><span
            class="method-args">(o)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="lex_state-3D-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 269</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">lex_state=</span> <span class="ruby-identifier">o</span>
  <span class="ruby-comment"># warn &quot;wtf lex_state = #{o.inspect} from #{caller.first}&quot;</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;wtf\?&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">Symbol</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">o</span>
  <span class="ruby-ivar">@lex_state</span> = <span class="ruby-identifier">o</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- lex_state-3D-source -->
          
        </div>

        

        
      </div><!-- lex_state-3D-method -->

    
      <div id="method-i-lineno" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">lineno</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="lineno-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 276</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">lineno</span>
  <span class="ruby-ivar">@lineno</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">lineno</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- lineno-source -->
          
        </div>

        

        
      </div><!-- lineno-method -->

    
      <div id="method-i-parse_number" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parse_number</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <pre>Parse a number from the input stream.</pre>

<p>@param c The first character of the number. @return A int constant wich
represents a token.</p>
          

          
          <div class="method-source-code" id="parse_number-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 286</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">parse_number</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>

  <span class="ruby-keyword">case</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[+-]?0[xXbBdD]\b/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;Invalid numeric format&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[+-]?(?:(?:[1-9][\d_]*|0)(?!\.\d)\b|0[Dd][0-9_]+)/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">int_with_base</span>(<span class="ruby-value">10</span>)
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[+-]?0x[a-f0-9_]+/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">int_with_base</span>(<span class="ruby-value">16</span>)
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[+-]?0[Bb][01_]+/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">int_with_base</span>(<span class="ruby-value">2</span>)
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[+-]?0[Oo]?[0-7_]*[89]/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;Illegal octal digit.&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[+-]?0[Oo]?[0-7_]+|0[Oo]/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">int_with_base</span>(<span class="ruby-value">8</span>)
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[+-]?[\d_]+_(e|\.)/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;Trailing '_' in number.&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[+-]?[\d_]+\.[\d_]+(e[+-]?[\d_]+)?\b|[+-]?[\d_]+e[+-]?[\d_]+\b/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">number</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">number</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/__/</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;Invalid numeric format&quot;</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">number</span>.<span class="ruby-identifier">to_f</span>
    <span class="ruby-value">:tFLOAT</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[+-]?[0-9_]+(?![e])/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">int_with_base</span>(<span class="ruby-value">10</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;Bad number format&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- parse_number-source -->
          
        </div>

        

        
      </div><!-- parse_number-method -->

    
      <div id="method-i-parse_quote" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parse_quote</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="parse_quote-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 318</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">parse_quote</span> <span class="ruby-comment"># 58 lines</span>
  <span class="ruby-identifier">beg</span>, <span class="ruby-identifier">nnd</span>, <span class="ruby-identifier">short_hand</span>, <span class="ruby-identifier">c</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">nil</span>, <span class="ruby-keyword">false</span>, <span class="ruby-keyword">nil</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[a-z0-9]{1,2}/</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># Long-hand (e.g. %Q{}).</span>
    <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;unknown type of %string&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched_size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>
    <span class="ruby-identifier">c</span>, <span class="ruby-identifier">beg</span>, <span class="ruby-identifier">short_hand</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>, <span class="ruby-identifier">src</span>.<span class="ruby-identifier">getch</span>, <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">else</span>                               <span class="ruby-comment"># Short-hand (e.g. %{, %., %!, etc)</span>
    <span class="ruby-identifier">c</span>, <span class="ruby-identifier">beg</span>, <span class="ruby-identifier">short_hand</span> = <span class="ruby-string">'Q'</span>, <span class="ruby-identifier">src</span>.<span class="ruby-identifier">getch</span>, <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">eos?</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">==</span> <span class="ruby-constant">RubyLexer</span><span class="ruby-operator">::</span><span class="ruby-constant">EOF</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">beg</span> <span class="ruby-operator">==</span> <span class="ruby-constant">RubyLexer</span><span class="ruby-operator">::</span><span class="ruby-constant">EOF</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;unterminated quoted string meets end of file&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># Figure nnd-char.  &quot;\0&quot; is special to indicate beg=nnd and that no nesting?</span>
  <span class="ruby-identifier">nnd</span> = { <span class="ruby-string">&quot;(&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;)&quot;</span>, <span class="ruby-string">&quot;[&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;]&quot;</span>, <span class="ruby-string">&quot;{&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;}&quot;</span>, <span class="ruby-string">&quot;&lt;&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">&quot;&gt;&quot;</span> }[<span class="ruby-identifier">beg</span>]
  <span class="ruby-identifier">nnd</span>, <span class="ruby-identifier">beg</span> = <span class="ruby-identifier">beg</span>, <span class="ruby-string">&quot;\00&quot;&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">nnd</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-identifier">token_type</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-node">&quot;%#{c}#{beg}&quot;</span>
  <span class="ruby-identifier">token_type</span>, <span class="ruby-identifier">string_type</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">c</span>
                            <span class="ruby-keyword">when</span> <span class="ruby-string">'Q'</span> <span class="ruby-keyword">then</span>
                              <span class="ruby-identifier">ch</span> = <span class="ruby-identifier">short_hand</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">nnd</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">beg</span>
                              <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-node">&quot;%#{ch}&quot;</span>
                              [<span class="ruby-value">:tSTRING_BEG</span>,   <span class="ruby-constant">STR_DQUOTE</span>]
                            <span class="ruby-keyword">when</span> <span class="ruby-string">'q'</span> <span class="ruby-keyword">then</span>
                              [<span class="ruby-value">:tSTRING_BEG</span>,   <span class="ruby-constant">STR_SQUOTE</span>]
                            <span class="ruby-keyword">when</span> <span class="ruby-string">'W'</span> <span class="ruby-keyword">then</span>
                              <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\s*/</span>)
                              [<span class="ruby-value">:tWORDS_BEG</span>,    <span class="ruby-constant">STR_DQUOTE</span> <span class="ruby-operator">|</span> <span class="ruby-constant">STR_FUNC_QWORDS</span>]
                            <span class="ruby-keyword">when</span> <span class="ruby-string">'w'</span> <span class="ruby-keyword">then</span>
                              <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\s*/</span>)
                              [<span class="ruby-value">:tQWORDS_BEG</span>,   <span class="ruby-constant">STR_SQUOTE</span> <span class="ruby-operator">|</span> <span class="ruby-constant">STR_FUNC_QWORDS</span>]
                            <span class="ruby-keyword">when</span> <span class="ruby-string">'x'</span> <span class="ruby-keyword">then</span>
                              [<span class="ruby-value">:tXSTRING_BEG</span>,  <span class="ruby-constant">STR_XQUOTE</span>]
                            <span class="ruby-keyword">when</span> <span class="ruby-string">'r'</span> <span class="ruby-keyword">then</span>
                              [<span class="ruby-value">:tREGEXP_BEG</span>,   <span class="ruby-constant">STR_REGEXP</span>]
                            <span class="ruby-keyword">when</span> <span class="ruby-string">'s'</span> <span class="ruby-keyword">then</span>
                              <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span>  = <span class="ruby-value">:expr_fname</span>
                              [<span class="ruby-value">:tSYMBEG</span>,       <span class="ruby-constant">STR_SSYM</span>]
                            <span class="ruby-keyword">when</span> <span class="ruby-string">'I'</span> <span class="ruby-keyword">then</span>
                              [<span class="ruby-value">:tSYMBOLS_BEG</span>, <span class="ruby-constant">STR_DQUOTE</span> <span class="ruby-operator">|</span> <span class="ruby-constant">STR_FUNC_QWORDS</span>]
                            <span class="ruby-keyword">when</span> <span class="ruby-string">'i'</span> <span class="ruby-keyword">then</span>
                              [<span class="ruby-value">:tQSYMBOLS_BEG</span>, <span class="ruby-constant">STR_SQUOTE</span> <span class="ruby-operator">|</span> <span class="ruby-constant">STR_FUNC_QWORDS</span>]
                            <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-node">&quot;Bad %string type. Expected [Qq\Wwxrs], found '#{c}'.&quot;</span> <span class="ruby-keyword">if</span>
    <span class="ruby-identifier">token_type</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_strterm</span> = [<span class="ruby-value">:strterm</span>, <span class="ruby-identifier">string_type</span>, <span class="ruby-identifier">nnd</span>, <span class="ruby-identifier">beg</span>]

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">token_type</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- parse_quote-source -->
          
        </div>

        

        
      </div><!-- parse_quote-method -->

    
      <div id="method-i-parse_string" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">parse_string</span><span
            class="method-args">(quote)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="parse_string-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 371</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">parse_string</span>(<span class="ruby-identifier">quote</span>) <span class="ruby-comment"># 65 lines</span>
  <span class="ruby-identifier">_</span>, <span class="ruby-identifier">string_type</span>, <span class="ruby-identifier">term</span>, <span class="ruby-identifier">open</span> = <span class="ruby-identifier">quote</span>

  <span class="ruby-identifier">space</span> = <span class="ruby-keyword">false</span> <span class="ruby-comment"># FIX: remove these</span>
  <span class="ruby-identifier">func</span> = <span class="ruby-identifier">string_type</span>
  <span class="ruby-identifier">paren</span> = <span class="ruby-identifier">open</span>
  <span class="ruby-identifier">term_re</span> = <span class="ruby-identifier">@@regexp_cache</span>[<span class="ruby-identifier">term</span>]

  <span class="ruby-identifier">qwords</span> = (<span class="ruby-identifier">func</span> &amp; <span class="ruby-constant">STR_FUNC_QWORDS</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">regexp</span> = (<span class="ruby-identifier">func</span> &amp; <span class="ruby-constant">STR_FUNC_REGEXP</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">expand</span> = (<span class="ruby-identifier">func</span> &amp; <span class="ruby-constant">STR_FUNC_EXPAND</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">func</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># FIX: impossible, prolly needs == 0</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lineno</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING_END</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">space</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">qwords</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\s+/</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">string_nest</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/#{term_re}/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">qwords</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">quote</span>[<span class="ruby-value">1</span>] = <span class="ruby-keyword">nil</span> <span class="ruby-comment"># TODO: make struct</span>
      <span class="ruby-keyword">return</span> <span class="ruby-value">:tSPACE</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">regexp</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">regx_options</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lineno</span> = <span class="ruby-keyword">nil</span>
      <span class="ruby-keyword">return</span> <span class="ruby-value">:tREGEXP_END</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">term</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lineno</span> = <span class="ruby-keyword">nil</span>
      <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING_END</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">space</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">return</span> <span class="ruby-value">:tSPACE</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">string_buffer</span> = []

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">expand</span>
    <span class="ruby-keyword">case</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/#(?=[$@])/</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING_DVAR</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/#[{]/</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING_DBEG</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/#/</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">'#'</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">tokadd_string</span>(<span class="ruby-identifier">func</span>, <span class="ruby-identifier">term</span>, <span class="ruby-identifier">paren</span>) <span class="ruby-operator">==</span> <span class="ruby-constant">RubyLexer</span><span class="ruby-operator">::</span><span class="ruby-constant">EOF</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;unterminated string meets end of file&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">string_buffer</span>.<span class="ruby-identifier">join</span>

  <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING_CONTENT</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- parse_string-source -->
          
        </div>

        

        
      </div><!-- parse_string-method -->

    
      <div id="method-i-process_token" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">process_token</span><span
            class="method-args">(command_state)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="process_token-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 1385</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">process_token</span>(<span class="ruby-identifier">command_state</span>)
  <span class="ruby-identifier">token</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">token</span> <span class="ruby-operator">=~</span> <span class="ruby-constant">IDENT_RE</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[\!\?](?!=)/</span>)

  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">last_state</span> = <span class="ruby-identifier">lex_state</span>

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">token</span>
  <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^\$/</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span>, <span class="ruby-identifier">result</span> = <span class="ruby-value">:expr_end</span>, <span class="ruby-value">:tGVAR</span>
  <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^@@/</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span>, <span class="ruby-identifier">result</span> = <span class="ruby-value">:expr_end</span>, <span class="ruby-value">:tCVAR</span>
  <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^@/</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span>, <span class="ruby-identifier">result</span> = <span class="ruby-value">:expr_end</span>, <span class="ruby-value">:tIVAR</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">token</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/[!?]$/</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span> = <span class="ruby-value">:tFID</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_fname</span> <span class="ruby-keyword">then</span>
        <span class="ruby-comment"># ident=, not =~ =&gt; == or followed by =&gt;</span>
        <span class="ruby-comment"># TODO test lexing of a=&gt;b vs a==&gt;b</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/=(?:(?![~&gt;=])|(?==&gt;))/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">result</span> = <span class="ruby-value">:tIDENTIFIER</span>
          <span class="ruby-identifier">token</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">result</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">token</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^[A-Z]/</span> <span class="ruby-keyword">then</span>
                   <span class="ruby-value">:tCONSTANT</span>
                 <span class="ruby-keyword">else</span>
                   <span class="ruby-value">:tIDENTIFIER</span>
                 <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">ruby18</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_label_possible?</span> <span class="ruby-identifier">command_state</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">colon</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/:/</span>)

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">colon</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">peek</span>(<span class="ruby-value">1</span>) <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;:&quot;</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = [<span class="ruby-identifier">token</span>, <span class="ruby-identifier">src</span>.<span class="ruby-identifier">lineno</span>]
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tLABEL</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">src</span>.<span class="ruby-identifier">unscan</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">colon</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_dot</span> <span class="ruby-keyword">then</span>
      <span class="ruby-comment"># See if it is a reserved word.</span>
      <span class="ruby-identifier">keyword</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby18</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># REFACTOR need 18/19 lexer subclasses</span>
                  <span class="ruby-constant">RubyParserStuff</span><span class="ruby-operator">::</span><span class="ruby-constant">Keyword</span>.<span class="ruby-identifier">keyword18</span> <span class="ruby-identifier">token</span>
                <span class="ruby-keyword">else</span>
                  <span class="ruby-constant">RubyParserStuff</span><span class="ruby-operator">::</span><span class="ruby-constant">Keyword</span>.<span class="ruby-identifier">keyword19</span> <span class="ruby-identifier">token</span>
                <span class="ruby-keyword">end</span>

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">keyword</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">state</span>           = <span class="ruby-identifier">lex_state</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span>  = <span class="ruby-identifier">keyword</span>.<span class="ruby-identifier">state</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = [<span class="ruby-identifier">token</span>, <span class="ruby-identifier">src</span>.<span class="ruby-identifier">lineno</span>]

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">state</span> <span class="ruby-operator">==</span> <span class="ruby-value">:expr_fname</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">keyword</span>.<span class="ruby-identifier">name</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">keyword</span>.<span class="ruby-identifier">id0</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">command_start</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lex_state</span> <span class="ruby-operator">==</span> <span class="ruby-value">:expr_beg</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">keyword</span>.<span class="ruby-identifier">id0</span> <span class="ruby-operator">==</span> <span class="ruby-value">:kDO</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">lpar_beg</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lpar_beg</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">paren_nest</span> <span class="ruby-keyword">then</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lpar_beg</span> = <span class="ruby-keyword">nil</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">paren_nest</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>

            <span class="ruby-keyword">return</span> <span class="ruby-value">:kDO_LAMBDA</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">return</span> <span class="ruby-value">:kDO_COND</span>  <span class="ruby-keyword">if</span> <span class="ruby-identifier">cond</span>.<span class="ruby-identifier">is_in_state</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:kDO_BLOCK</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">cmdarg</span>.<span class="ruby-identifier">is_in_state</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">state</span> <span class="ruby-operator">!=</span> <span class="ruby-value">:expr_cmdarg</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:kDO_BLOCK</span> <span class="ruby-keyword">if</span> [<span class="ruby-value">:expr_beg</span>, <span class="ruby-value">:expr_endarg</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">state</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:kDO</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">return</span> <span class="ruby-identifier">keyword</span>.<span class="ruby-identifier">id0</span> <span class="ruby-keyword">if</span> [<span class="ruby-value">:expr_beg</span>, <span class="ruby-value">:expr_value</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">state</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">keyword</span>.<span class="ruby-identifier">id0</span> <span class="ruby-operator">!=</span> <span class="ruby-identifier">keyword</span>.<span class="ruby-identifier">id1</span>

        <span class="ruby-keyword">return</span> <span class="ruby-identifier">keyword</span>.<span class="ruby-identifier">id1</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># TODO:</span>
    <span class="ruby-comment"># if (mb == ENC_CODERANGE_7BIT &amp;&amp; lex_state != EXPR_DOT) {</span>

    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> =
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_beg?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">is_arg?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">in_lex_state?</span>(<span class="ruby-value">:expr_dot</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">command_state</span> <span class="ruby-keyword">then</span>
          <span class="ruby-value">:expr_cmdarg</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-value">:expr_arg</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span><span class="ruby-identifier">ruby18</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">in_lex_state?</span>(<span class="ruby-value">:expr_fname</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-value">:expr_endfn</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-value">:expr_end</span>
      <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">token</span>

  <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span>[<span class="ruby-value">:expr_dot</span>, <span class="ruby-value">:expr_fname</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">last_state</span>) <span class="ruby-operator">&amp;&amp;</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parser</span>.<span class="ruby-identifier">env</span>[<span class="ruby-identifier">token</span>.<span class="ruby-identifier">to_sym</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:lvar</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- process_token-source -->
          
        </div>

        

        
      </div><!-- process_token-method -->

    
      <div id="method-i-rb_compile_error" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">rb_compile_error</span><span
            class="method-args">(msg)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="rb_compile_error-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 431</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-identifier">msg</span>
  <span class="ruby-identifier">msg</span> <span class="ruby-operator">+=</span> <span class="ruby-node">&quot;. near line #{self.lineno}: #{src.rest[/^.*/].inspect}&quot;</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">RubyParser</span><span class="ruby-operator">::</span><span class="ruby-constant">SyntaxError</span>, <span class="ruby-identifier">msg</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- rb_compile_error-source -->
          
        </div>

        

        
      </div><!-- rb_compile_error-method -->

    
      <div id="method-i-read_escape" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">read_escape</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="read_escape-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 436</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">read_escape</span> <span class="ruby-comment"># 51 lines</span>
  <span class="ruby-keyword">case</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\/</span>) <span class="ruby-keyword">then</span>                  <span class="ruby-comment"># Backslash</span>
    <span class="ruby-string">'\'</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/n/</span>) <span class="ruby-keyword">then</span>                   <span class="ruby-comment"># newline</span>
    <span class="ruby-string">&quot;\n&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/t/</span>) <span class="ruby-keyword">then</span>                   <span class="ruby-comment"># horizontal tab</span>
    <span class="ruby-string">&quot;\t&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/r/</span>) <span class="ruby-keyword">then</span>                   <span class="ruby-comment"># carriage-return</span>
    <span class="ruby-string">&quot;\r&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/f/</span>) <span class="ruby-keyword">then</span>                   <span class="ruby-comment"># form-feed</span>
    <span class="ruby-string">&quot;\f&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/v/</span>) <span class="ruby-keyword">then</span>                   <span class="ruby-comment"># vertical tab</span>
    <span class="ruby-string">&quot;\113&quot;&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/a/</span>) <span class="ruby-keyword">then</span>                   <span class="ruby-comment"># alarm(bell)</span>
    <span class="ruby-string">&quot;\0007&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/e/</span>) <span class="ruby-keyword">then</span>                   <span class="ruby-comment"># escape</span>
    <span class="ruby-string">&quot;\0033&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/b/</span>) <span class="ruby-keyword">then</span>                   <span class="ruby-comment"># backspace</span>
    <span class="ruby-string">&quot;\0010&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/s/</span>) <span class="ruby-keyword">then</span>                   <span class="ruby-comment"># space</span>
    <span class="ruby-string">&quot; &quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[0-7]{1,3}/</span>) <span class="ruby-keyword">then</span>          <span class="ruby-comment"># octal constant</span>
    (<span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>.<span class="ruby-identifier">to_i</span>(<span class="ruby-value">8</span>) &amp; <span class="ruby-value">0xFF</span>).<span class="ruby-identifier">chr</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/x([0-9a-fA-F]{1,2})/</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># hex constant</span>
    <span class="ruby-identifier">src</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>(<span class="ruby-value">16</span>).<span class="ruby-identifier">chr</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/M-\[\MCc]/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/M-\/</span>) <span class="ruby-comment"># eat it</span>
    <span class="ruby-identifier">c</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">read_escape</span>
    <span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>] = (<span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">ord</span> <span class="ruby-operator">|</span> <span class="ruby-value">0x80</span>).<span class="ruby-identifier">chr</span>
    <span class="ruby-identifier">c</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/M-(.)/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">c</span> = <span class="ruby-identifier">src</span>[<span class="ruby-value">1</span>]
    <span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>] = (<span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">ord</span> <span class="ruby-operator">|</span> <span class="ruby-value">0x80</span>).<span class="ruby-identifier">chr</span>
    <span class="ruby-identifier">c</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/(C-|c)\[\MCc]/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/(C-|c)\/</span>) <span class="ruby-comment"># eat it</span>
    <span class="ruby-identifier">c</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">read_escape</span>
    <span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>] = (<span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">ord</span> &amp; <span class="ruby-value">0x9f</span>).<span class="ruby-identifier">chr</span>
    <span class="ruby-identifier">c</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/C-\?|c\?/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-value">127</span>.<span class="ruby-identifier">chr</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/(C-|c)(.)/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">c</span> = <span class="ruby-identifier">src</span>[<span class="ruby-value">2</span>]
    <span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>] = (<span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">ord</span> &amp; <span class="ruby-value">0x9f</span>).<span class="ruby-identifier">chr</span>
    <span class="ruby-identifier">c</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/^[89]/</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># bad octal or hex... MRI ignores them :(</span>
    <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[McCx0-9]/</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">eos?</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">rb_compile_error</span>(<span class="ruby-string">&quot;Invalid escape character syntax&quot;</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">src</span>.<span class="ruby-identifier">getch</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- read_escape-source -->
          
        </div>

        

        
      </div><!-- read_escape-method -->

    
      <div id="method-i-regx_options" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">regx_options</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="regx_options-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 491</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">regx_options</span> <span class="ruby-comment"># 15 lines</span>
  <span class="ruby-identifier">good</span>, <span class="ruby-identifier">bad</span> = [], []

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[a-z]+/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">good</span>, <span class="ruby-identifier">bad</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">//</span>).<span class="ruby-identifier">partition</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^[ixmonesu]$/</span> }
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">bad</span>.<span class="ruby-identifier">empty?</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">rb_compile_error</span>(<span class="ruby-string">&quot;unknown regexp option%s - %s&quot;</span> <span class="ruby-operator">%</span>
                     [(<span class="ruby-identifier">bad</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;s&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;&quot;</span>), <span class="ruby-identifier">bad</span>.<span class="ruby-identifier">join</span>.<span class="ruby-identifier">inspect</span>])
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">good</span>.<span class="ruby-identifier">join</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- regx_options-source -->
          
        </div>

        

        
      </div><!-- regx_options-method -->

    
      <div id="method-i-reset" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reset</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="reset-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 506</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">reset</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">command_start</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_strterm</span>   = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">token</span>         = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span>    = <span class="ruby-keyword">nil</span>

  <span class="ruby-ivar">@src</span>       = <span class="ruby-keyword">nil</span>
  <span class="ruby-ivar">@lex_state</span> = <span class="ruby-keyword">nil</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- reset-source -->
          
        </div>

        

        
      </div><!-- reset-method -->

    
      <div id="method-i-ruby18" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ruby18</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="ruby18-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 516</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ruby18</span>
  <span class="ruby-constant">Ruby18Parser</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">parser</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- ruby18-source -->
          
        </div>

        

        
      </div><!-- ruby18-method -->

    
      <div id="method-i-ruby19" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ruby19</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="ruby19-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 520</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ruby19</span>
  <span class="ruby-constant">Ruby19Parser</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">parser</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- ruby19-source -->
          
        </div>

        

        
      </div><!-- ruby19-method -->

    
      <div id="method-i-src-3D" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">src=</span><span
            class="method-args">(src)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="src-3D-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 524</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">src=</span> <span class="ruby-identifier">src</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;bad src: #{src.inspect}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">src</span>
  <span class="ruby-ivar">@src</span> = <span class="ruby-constant">RPStringScanner</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">src</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- src-3D-source -->
          
        </div>

        

        
      </div><!-- src-3D-method -->

    
      <div id="method-i-tokadd_escape" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tokadd_escape</span><span
            class="method-args">(term)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="tokadd_escape-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 529</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">tokadd_escape</span> <span class="ruby-identifier">term</span> <span class="ruby-comment"># 20 lines</span>
  <span class="ruby-keyword">case</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\\n/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-comment"># just ignore</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\([0-7]{1,3}|x[0-9a-fA-F]{1,2})/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\([MC]-|c)(?=\)/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tokadd_escape</span> <span class="ruby-identifier">term</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\([MC]-|c)(.)/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\[McCx]/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;Invalid escape character syntax&quot;</span>
  <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\(.)/</span>) <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;Invalid escape character syntax&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- tokadd_escape-source -->
          
        </div>

        

        
      </div><!-- tokadd_escape-method -->

    
      <div id="method-i-tokadd_string" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">tokadd_string</span><span
            class="method-args">(func, term, paren)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="tokadd_string-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 552</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">tokadd_string</span>(<span class="ruby-identifier">func</span>, <span class="ruby-identifier">term</span>, <span class="ruby-identifier">paren</span>) <span class="ruby-comment"># 105 lines</span>
  <span class="ruby-identifier">qwords</span> = (<span class="ruby-identifier">func</span> &amp; <span class="ruby-constant">STR_FUNC_QWORDS</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">escape</span> = (<span class="ruby-identifier">func</span> &amp; <span class="ruby-constant">STR_FUNC_ESCAPE</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">expand</span> = (<span class="ruby-identifier">func</span> &amp; <span class="ruby-constant">STR_FUNC_EXPAND</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">regexp</span> = (<span class="ruby-identifier">func</span> &amp; <span class="ruby-constant">STR_FUNC_REGEXP</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-identifier">symbol</span> = (<span class="ruby-identifier">func</span> &amp; <span class="ruby-constant">STR_FUNC_SYMBOL</span>) <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>

  <span class="ruby-identifier">paren_re</span> = <span class="ruby-identifier">@@regexp_cache</span>[<span class="ruby-identifier">paren</span>]
  <span class="ruby-identifier">term_re</span>  = <span class="ruby-identifier">@@regexp_cache</span>[<span class="ruby-identifier">term</span>]

  <span class="ruby-keyword">until</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">eos?</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">c</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">handled</span> = <span class="ruby-keyword">true</span>

    <span class="ruby-keyword">case</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">paren_re</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-identifier">paren_re</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">string_nest</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-identifier">term_re</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">string_nest</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">src</span>.<span class="ruby-identifier">pos</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">break</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">string_nest</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">expand</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/#(?=[\$\@\{])/</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">src</span>.<span class="ruby-identifier">pos</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">qwords</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\s/</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">src</span>.<span class="ruby-identifier">pos</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
      <span class="ruby-keyword">break</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">expand</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/#(?!\n)/</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-comment"># do nothing</span>
    <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\/</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">case</span>
      <span class="ruby-keyword">when</span> <span class="ruby-identifier">qwords</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\\n/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\n&quot;</span>
        <span class="ruby-keyword">next</span>
      <span class="ruby-keyword">when</span> <span class="ruby-identifier">qwords</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\\s/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">c</span> = <span class="ruby-string">' '</span>
      <span class="ruby-keyword">when</span> <span class="ruby-identifier">expand</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\\n/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">next</span>
      <span class="ruby-keyword">when</span> <span class="ruby-identifier">regexp</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tokadd_escape</span> <span class="ruby-identifier">term</span>
        <span class="ruby-keyword">next</span>
      <span class="ruby-keyword">when</span> <span class="ruby-identifier">expand</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">c</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">read_escape</span>
      <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\\n/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-comment"># do nothing</span>
      <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\\/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">'\'</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">escape</span>
        <span class="ruby-identifier">c</span> = <span class="ruby-string">'\'</span>
      <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-identifier">term_re</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">paren</span>.<span class="ruby-identifier">nil?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-identifier">paren_re</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-string">&quot;\\&quot;</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">handled</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-keyword">end</span> <span class="ruby-comment"># inner /\\/ case</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">handled</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span> <span class="ruby-comment"># top case</span>

    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">handled</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">t</span> = <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">escape</span> <span class="ruby-identifier">term</span>
      <span class="ruby-identifier">x</span> = <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">escape</span>(<span class="ruby-identifier">paren</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">paren</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">paren</span> <span class="ruby-operator">!=</span> <span class="ruby-string">&quot;\0000&quot;</span>
      <span class="ruby-identifier">re</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">qwords</span> <span class="ruby-keyword">then</span>
             <span class="ruby-keyword">if</span> <span class="ruby-constant">RUBY19</span> <span class="ruby-keyword">then</span>
               <span class="ruby-node">/[^#{t}#{x}\#\0\\s]+|./</span> <span class="ruby-comment"># |. to pick up whatever</span>
             <span class="ruby-keyword">else</span>
               <span class="ruby-node">/[^#{t}#{x}\#\0\\s\v]+|./</span> <span class="ruby-comment"># argh. 1.8's \s doesn't pick up \v</span>
             <span class="ruby-keyword">end</span>
           <span class="ruby-keyword">else</span>
             <span class="ruby-node">/[^#{t}#{x}\#\0\]+|./</span>
           <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span> <span class="ruby-identifier">re</span>
      <span class="ruby-identifier">c</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>

      <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;symbol cannot contain '\\0'&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">symbol</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\0/</span>
    <span class="ruby-keyword">end</span> <span class="ruby-comment"># unless handled</span>

    <span class="ruby-identifier">c</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
    <span class="ruby-identifier">string_buffer</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">c</span>
  <span class="ruby-keyword">end</span> <span class="ruby-comment"># until</span>

  <span class="ruby-identifier">c</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
  <span class="ruby-identifier">c</span> = <span class="ruby-constant">RubyLexer</span><span class="ruby-operator">::</span><span class="ruby-constant">EOF</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">eos?</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">c</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- tokadd_string-source -->
          
        </div>

        

        
      </div><!-- tokadd_string-method -->

    
      <div id="method-i-unescape" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">unescape</span><span
            class="method-args">(s)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="unescape-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 659</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">unescape</span> <span class="ruby-identifier">s</span>
  <span class="ruby-identifier">r</span> = <span class="ruby-constant">ESCAPES</span>[<span class="ruby-identifier">s</span>]

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">r</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">r</span>

  <span class="ruby-identifier">x</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">s</span>
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^[0-7]{1,3}/</span> <span class="ruby-keyword">then</span>
        (<span class="ruby-node">$&amp;</span>.<span class="ruby-identifier">to_i</span>(<span class="ruby-value">8</span>) &amp; <span class="ruby-value">0xFF</span>).<span class="ruby-identifier">chr</span>
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^x([0-9a-fA-F]{1,2})/</span> <span class="ruby-keyword">then</span>
        <span class="ruby-node">$1</span>.<span class="ruby-identifier">to_i</span>(<span class="ruby-value">16</span>).<span class="ruby-identifier">chr</span>
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^M-(.)/</span> <span class="ruby-keyword">then</span>
        (<span class="ruby-node">$1</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">ord</span> <span class="ruby-operator">|</span> <span class="ruby-value">0x80</span>).<span class="ruby-identifier">chr</span>
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^(C-|c)(.)/</span> <span class="ruby-keyword">then</span>
        (<span class="ruby-node">$2</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">ord</span> &amp; <span class="ruby-value">0x9f</span>).<span class="ruby-identifier">chr</span>
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^[89a-f]/</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># bad octal or hex... ignore? that's what MRI does :(</span>
        <span class="ruby-identifier">s</span>
      <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^[McCx0-9]/</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">rb_compile_error</span>(<span class="ruby-string">&quot;Invalid escape character syntax&quot;</span>)
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">s</span>
      <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">x</span>.<span class="ruby-identifier">force_encoding</span> <span class="ruby-string">&quot;UTF-8&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">RUBY19</span>
  <span class="ruby-identifier">x</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- unescape-source -->
          
        </div>

        

        
      </div><!-- unescape-method -->

    
      <div id="method-i-warning" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">warning</span><span
            class="method-args">(s)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="warning-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 684</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">warning</span> <span class="ruby-identifier">s</span>
  <span class="ruby-comment"># do nothing for now</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- warning-source -->
          
        </div>

        

        
      </div><!-- warning-method -->

    
      <div id="method-i-yylex" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">yylex</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns the next token. Also sets yy_val is needed.</p>

<p>@return Description of the Returned Value</p>
          

          
          <div class="method-source-code" id="yylex-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 693</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">yylex</span> <span class="ruby-comment"># 826 lines</span>
  <span class="ruby-identifier">c</span> = <span class="ruby-string">''</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">space_seen</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">command_state</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">src</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">src</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">token</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-keyword">nil</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">yylex_string</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lex_strterm</span>

  <span class="ruby-identifier">command_state</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">command_start</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">command_start</span> = <span class="ruby-keyword">false</span>

  <span class="ruby-identifier">last_state</span> = <span class="ruby-identifier">lex_state</span>

  <span class="ruby-identifier">loop</span> <span class="ruby-keyword">do</span> <span class="ruby-comment"># START OF CASE</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[\ \t\r\f\v]/</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># \s - \n + \v</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">space_seen</span> = <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">next</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/[^a-zA-Z]/</span>) <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/\n|#/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lineno</span> = <span class="ruby-keyword">nil</span>
        <span class="ruby-identifier">c</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">==</span> <span class="ruby-string">'#'</span> <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">src</span>.<span class="ruby-identifier">pos</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>

          <span class="ruby-keyword">while</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/\s*#.*(\n+|\z)/</span>) <span class="ruby-keyword">do</span>
            <span class="ruby-ivar">@comments</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-node">/^ +#/</span>, <span class="ruby-string">'#'</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/^ +$/</span>, <span class="ruby-string">''</span>)
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">return</span> <span class="ruby-constant">RubyLexer</span><span class="ruby-operator">::</span><span class="ruby-constant">EOF</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">eos?</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-comment"># Replace a string of newlines with a single one</span>
        <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\n+/</span>)

        <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_lex_state?</span>(<span class="ruby-value">:expr_beg</span>, <span class="ruby-value">:expr_value</span>, <span class="ruby-value">:expr_class</span>,
                              <span class="ruby-value">:expr_fname</span>, <span class="ruby-value">:expr_dot</span>)

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/([\ \t\r\f\v]*)\./</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">space_seen</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">src</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">empty?</span>

          <span class="ruby-identifier">src</span>.<span class="ruby-identifier">pos</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
          <span class="ruby-keyword">next</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\.\./</span>)
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">command_start</span> = <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tNL</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[\]\)\}]/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;}&quot;</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">brace_nest</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">paren_nest</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">cond</span>.<span class="ruby-identifier">lexpop</span>
        <span class="ruby-identifier">cmdarg</span>.<span class="ruby-identifier">lexpop</span>
        <span class="ruby-identifier">tern</span>.<span class="ruby-identifier">lexpop</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;)&quot;</span> <span class="ruby-keyword">then</span>
                           <span class="ruby-value">:expr_endfn</span>
                         <span class="ruby-keyword">else</span>
                           <span class="ruby-value">:expr_endarg</span>
                         <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
        <span class="ruby-identifier">result</span> = {
          <span class="ruby-string">&quot;)&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:tRPAREN</span>,
          <span class="ruby-string">&quot;]&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:tRBRACK</span>,
          <span class="ruby-string">&quot;}&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">:tRCURLY</span>
        }[<span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>]
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\!/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_lex_state?</span>(<span class="ruby-value">:expr_fname</span>, <span class="ruby-value">:expr_dot</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_arg</span>

          <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/@/</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;!@&quot;</span>
            <span class="ruby-keyword">return</span> <span class="ruby-value">:tUBANG</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[=~]/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-node">&quot;!#{src.matched}&quot;</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;!&quot;</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">return</span> <span class="ruby-constant">TOKENS</span>[<span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span>]
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\.\.\.?|,|![=~]?/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
        <span class="ruby-identifier">tok</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
        <span class="ruby-keyword">return</span> <span class="ruby-constant">TOKENS</span>[<span class="ruby-identifier">tok</span>]
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\./</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\.\d/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;no .&lt;digit&gt; floating literal anymore put 0 before dot&quot;</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\./</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_dot</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;.&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tDOT</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\(/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby18</span> <span class="ruby-keyword">then</span>
                   <span class="ruby-identifier">yylex_paren18</span>
                 <span class="ruby-keyword">else</span>
                   <span class="ruby-identifier">yylex_paren19</span>
                 <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">paren_nest</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expr_beg_push</span> <span class="ruby-string">&quot;(&quot;</span>

        <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\=/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\=\=\=|\=\=|\=~|\=&gt;|\=(?!begin\b)/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-identifier">tok</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
          <span class="ruby-keyword">return</span> <span class="ruby-constant">TOKENS</span>[<span class="ruby-identifier">tok</span>]
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\=begin(?=\s)/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-ivar">@comments</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>

          <span class="ruby-keyword">unless</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/.*?\n=end( |\t|\f)*[^\n]*(\n|\z)/</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-ivar">@comments</span>.<span class="ruby-identifier">clear</span>
            <span class="ruby-identifier">rb_compile_error</span>(<span class="ruby-string">&quot;embedded document meets end of file&quot;</span>)
          <span class="ruby-keyword">end</span>

          <span class="ruby-ivar">@comments</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>

          <span class="ruby-keyword">next</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;you shouldn't be able to get here&quot;</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/\&quot;(#{ESC_RE}|#(#{ESC_RE}|[^\{\#\@\$\&quot;\])|[^\&quot;\\#])*\&quot;/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>].<span class="ruby-identifier">gsub</span>(<span class="ruby-constant">ESC_RE</span>) { <span class="ruby-identifier">unescape</span> <span class="ruby-node">$1</span> }
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&quot;/</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># FALLBACK</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_strterm</span> = [<span class="ruby-value">:strterm</span>, <span class="ruby-constant">STR_DQUOTE</span>, <span class="ruby-string">'&quot;'</span>, <span class="ruby-string">&quot;\00&quot;&quot;</span>] <span class="ruby-comment"># TODO: question this</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;\&quot;&quot;</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING_BEG</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/\@\@?#{IDENT_CHAR_RE}+/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">token</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>

        <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-node">&quot;`#{token}` is not allowed as a variable name&quot;</span> <span class="ruby-keyword">if</span>
          <span class="ruby-identifier">token</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\@\d/</span>

        <span class="ruby-keyword">return</span> <span class="ruby-identifier">process_token</span>(<span class="ruby-identifier">command_state</span>)
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\:\:/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_beg?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">in_lex_state?</span>(<span class="ruby-value">:expr_class</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">is_space_arg?</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;::&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tCOLON3</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_dot</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;::&quot;</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tCOLON2</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span> <span class="ruby-identifier">is_end?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-node">/:([a-zA-Z_]#{IDENT_CHAR_RE}*(?:[?!]|=(?==&gt;)|=(?![=&gt;]))?)/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-comment"># scanning shortcut to symbols</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>[<span class="ruby-value">1</span>]
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tSYMBOL</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\:/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-comment"># ?: / then / when</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_end?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\s/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-comment"># TODO warn_balanced(&quot;:&quot;, &quot;symbol literal&quot;);</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;:&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tCOLON</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">case</span>
        <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_strterm</span> = [<span class="ruby-value">:strterm</span>, <span class="ruby-constant">STR_SSYM</span>, <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>, <span class="ruby-string">&quot;\00&quot;&quot;</span>]
        <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&quot;/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_strterm</span> = [<span class="ruby-value">:strterm</span>, <span class="ruby-constant">STR_DSYM</span>, <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>, <span class="ruby-string">&quot;\00&quot;&quot;</span>]
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_fname</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;:&quot;</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tSYMBEG</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/[0-9]/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">parse_number</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\[/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">paren_nest</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>

        <span class="ruby-identifier">result</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_fname</span>, <span class="ruby-value">:expr_dot</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_arg</span>
          <span class="ruby-keyword">case</span>
          <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\]\=/</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">paren_nest</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span> <span class="ruby-comment"># HACK? I dunno, or bug in MRI</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;[]=&quot;</span>
            <span class="ruby-keyword">return</span> <span class="ruby-value">:tASET</span>
          <span class="ruby-keyword">when</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\]/</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">paren_nest</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span> <span class="ruby-comment"># HACK? I dunno, or bug in MRI</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;[]&quot;</span>
            <span class="ruby-keyword">return</span> <span class="ruby-value">:tAREF</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;unexpected '['&quot;</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">is_beg?</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tern</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">false</span>
          <span class="ruby-identifier">result</span> = <span class="ruby-value">:tLBRACK</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">is_arg?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">space_seen</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tern</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">false</span>
          <span class="ruby-identifier">result</span> = <span class="ruby-value">:tLBRACK</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">result</span> = <span class="ruby-value">:tLBRACK2</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expr_beg_push</span> <span class="ruby-string">&quot;[&quot;</span>

        <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\(\.|[^\])*\/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-2</span>].<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/\\/</span>, <span class="ruby-string">&quot;\\&quot;</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/\'/</span>, <span class="ruby-string">&quot;'&quot;</span>) <span class="ruby-comment"># &quot;</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\|/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\|\|\=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;||&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tOP_ASGN</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\|\|/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;||&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tOROP</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\|\=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;|&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tOP_ASGN</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\|/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;|&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tPIPE</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\{/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">brace_nest</span> <span class="ruby-operator">+=</span> <span class="ruby-value">1</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">lpar_beg</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">lpar_beg</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">paren_nest</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lpar_beg</span> = <span class="ruby-keyword">nil</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">paren_nest</span> <span class="ruby-operator">-=</span> <span class="ruby-value">1</span>

          <span class="ruby-identifier">expr_beg_push</span> <span class="ruby-string">&quot;{&quot;</span>

          <span class="ruby-keyword">return</span> <span class="ruby-value">:tLAMBEG</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">result</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_arg?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">in_lex_state?</span>(<span class="ruby-value">:expr_end</span>, <span class="ruby-value">:expr_endfn</span>) <span class="ruby-keyword">then</span>
                   <span class="ruby-value">:tLCURLY</span>      <span class="ruby-comment">#  block (primary)</span>
                 <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">in_lex_state?</span>(<span class="ruby-value">:expr_endarg</span>) <span class="ruby-keyword">then</span>
                   <span class="ruby-value">:tLBRACE_ARG</span>  <span class="ruby-comment">#  block (expr)</span>
                 <span class="ruby-keyword">else</span>
                   <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tern</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">false</span>
                   <span class="ruby-value">:tLBRACE</span>      <span class="ruby-comment">#  hash</span>
                 <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">expr_beg_push</span> <span class="ruby-string">&quot;{&quot;</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">command_start</span> = <span class="ruby-keyword">true</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">result</span> <span class="ruby-operator">==</span> <span class="ruby-value">:tLBRACE</span>

        <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/-&gt;/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_endfn</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tLAMBDA</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/[+-]/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">sign</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
        <span class="ruby-identifier">utype</span>, <span class="ruby-identifier">type</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">sign</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;+&quot;</span> <span class="ruby-keyword">then</span>
                        [<span class="ruby-value">:tUPLUS</span>, <span class="ruby-value">:tPLUS</span>]
                      <span class="ruby-keyword">else</span>
                        [<span class="ruby-value">:tUMINUS</span>, <span class="ruby-value">:tMINUS</span>]
                      <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_fname</span>, <span class="ruby-value">:expr_dot</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_arg</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/@/</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-node">&quot;#{sign}@&quot;</span>
            <span class="ruby-keyword">return</span> <span class="ruby-identifier">utype</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">sign</span>
            <span class="ruby-keyword">return</span> <span class="ruby-identifier">type</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">sign</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tOP_ASGN</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> (<span class="ruby-identifier">is_beg?</span> <span class="ruby-operator">||</span> (<span class="ruby-identifier">is_arg?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">space_seen</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\s/</span>))) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_arg?</span> <span class="ruby-keyword">then</span>
            <span class="ruby-identifier">arg_ambiguous</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">sign</span>

          <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\d/</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-keyword">if</span> <span class="ruby-identifier">utype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:tUPLUS</span> <span class="ruby-keyword">then</span>
              <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parse_number</span>
            <span class="ruby-keyword">else</span>
              <span class="ruby-keyword">return</span> <span class="ruby-value">:tUMINUS_NUM</span>
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">return</span> <span class="ruby-identifier">utype</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">sign</span>
        <span class="ruby-keyword">return</span> <span class="ruby-identifier">type</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\*/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\*\*=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;**&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tOP_ASGN</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\*\*/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">result</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_space_arg?</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/./</span>) <span class="ruby-keyword">then</span>
                     <span class="ruby-identifier">warning</span> <span class="ruby-string">&quot;`**' interpreted as argument prefix&quot;</span>
                     <span class="ruby-value">:tDSTAR</span>
                   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">is_beg?</span> <span class="ruby-keyword">then</span>
                     <span class="ruby-value">:tDSTAR</span>
                   <span class="ruby-keyword">else</span>
                     <span class="ruby-comment"># TODO: warn_balanced(&quot;**&quot;, &quot;argument prefix&quot;);</span>
                     <span class="ruby-value">:tPOW</span>
                   <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;**&quot;</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\*\=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;*&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tOP_ASGN</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\*/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">result</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_space_arg?</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/./</span>) <span class="ruby-keyword">then</span>
                     <span class="ruby-identifier">warning</span>(<span class="ruby-string">&quot;`*' interpreted as argument prefix&quot;</span>)
                     <span class="ruby-value">:tSTAR</span>
                   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">is_beg?</span> <span class="ruby-keyword">then</span>
                     <span class="ruby-value">:tSTAR</span>
                   <span class="ruby-keyword">else</span>
                     <span class="ruby-comment"># TODO: warn_balanced(&quot;*&quot;, &quot;argument prefix&quot;);</span>
                     <span class="ruby-value">:tSTAR2</span> <span class="ruby-comment"># TODO: rename</span>
                   <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;*&quot;</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\&lt;/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&lt;\=\&gt;/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;&lt;=&gt;&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tCMP</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&lt;\=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;&lt;=&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tLEQ</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&lt;\&lt;\=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;\&lt;\&lt;&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tOP_ASGN</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&lt;\&lt;/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">if</span> (<span class="ruby-operator">!</span><span class="ruby-identifier">in_lex_state?</span>(<span class="ruby-value">:expr_dot</span>, <span class="ruby-value">:expr_class</span>) <span class="ruby-operator">&amp;&amp;</span>
              <span class="ruby-operator">!</span><span class="ruby-identifier">is_end?</span> <span class="ruby-operator">&amp;&amp;</span>
              (<span class="ruby-operator">!</span><span class="ruby-identifier">is_arg?</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">space_seen</span>)) <span class="ruby-keyword">then</span>
            <span class="ruby-identifier">tok</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">heredoc_identifier</span>
            <span class="ruby-keyword">return</span> <span class="ruby-identifier">tok</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tok</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;\&lt;\&lt;&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tLSHFT</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&lt;/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;&lt;&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tLT</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\&gt;/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&gt;\=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;&gt;=&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tGEQ</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&gt;\&gt;=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;&gt;&gt;&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tOP_ASGN</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&gt;\&gt;/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;&gt;&gt;&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tRSHFT</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&gt;/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;&gt;&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tGT</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\`/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;`&quot;</span>
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">lex_state</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:expr_fname</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tBACK_REF2</span>
        <span class="ruby-keyword">when</span> <span class="ruby-value">:expr_dot</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">command_state</span> <span class="ruby-keyword">then</span>
                             <span class="ruby-value">:expr_cmdarg</span>
                           <span class="ruby-keyword">else</span>
                             <span class="ruby-value">:expr_arg</span>
                           <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tBACK_REF2</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_strterm</span> = [<span class="ruby-value">:strterm</span>, <span class="ruby-constant">STR_XQUOTE</span>, <span class="ruby-string">'`'</span>, <span class="ruby-string">&quot;\00&quot;&quot;</span>]
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tXSTRING_BEG</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\?/</span>) <span class="ruby-keyword">then</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_end?</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-identifier">ruby18</span> <span class="ruby-operator">?</span> <span class="ruby-value">:expr_beg</span> <span class="ruby-operator">:</span> <span class="ruby-value">:expr_value</span> <span class="ruby-comment"># HACK?</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tern</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">true</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;?&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tEH</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">eos?</span> <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;incomplete character syntax&quot;</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\s|\v/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">unless</span> <span class="ruby-identifier">is_arg?</span> <span class="ruby-keyword">then</span>
            <span class="ruby-identifier">c2</span> = { <span class="ruby-string">&quot; &quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'s'</span>,
                  <span class="ruby-string">&quot;\n&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'n'</span>,
                  <span class="ruby-string">&quot;\t&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'t'</span>,
                  <span class="ruby-string">&quot;\v&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'v'</span>,
                  <span class="ruby-string">&quot;\r&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'r'</span>,
                  <span class="ruby-string">&quot;\f&quot;</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'f'</span> }[<span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>]

            <span class="ruby-keyword">if</span> <span class="ruby-identifier">c2</span> <span class="ruby-keyword">then</span>
              <span class="ruby-identifier">warning</span>(<span class="ruby-string">&quot;invalid character syntax; use ?\\&quot;</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">c2</span>)
            <span class="ruby-keyword">end</span>
          <span class="ruby-keyword">end</span>

          <span class="ruby-comment"># ternary</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-identifier">ruby18</span> <span class="ruby-operator">?</span> <span class="ruby-value">:expr_beg</span> <span class="ruby-operator">:</span> <span class="ruby-value">:expr_value</span> <span class="ruby-comment"># HACK?</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tern</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">true</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;?&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tEH</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\w(?=\w)/</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># ternary, also</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tern</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">true</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;?&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tEH</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-identifier">c</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\/</span>) <span class="ruby-keyword">then</span>
              <span class="ruby-keyword">self</span>.<span class="ruby-identifier">read_escape</span>
            <span class="ruby-keyword">else</span>
              <span class="ruby-identifier">src</span>.<span class="ruby-identifier">getch</span>
            <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">version</span> <span class="ruby-operator">==</span> <span class="ruby-value">18</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">ord</span> &amp; <span class="ruby-value">0xff</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tINTEGER</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">c</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tSTRING</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\&amp;/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&amp;\&amp;\=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;&amp;&amp;&quot;</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tOP_ASGN</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&amp;\&amp;/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;&amp;&amp;&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tANDOP</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\&amp;\=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;&amp;&quot;</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tOP_ASGN</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/&amp;/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">result</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_arg?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">space_seen</span> <span class="ruby-operator">&amp;&amp;</span>
                       <span class="ruby-operator">!</span><span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\s/</span>) <span class="ruby-keyword">then</span>
                     <span class="ruby-identifier">warning</span>(<span class="ruby-string">&quot;`&amp;' interpreted as argument prefix&quot;</span>)
                     <span class="ruby-value">:tAMPER</span>
                   <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_beg</span>, <span class="ruby-value">:expr_mid</span> <span class="ruby-keyword">then</span>
                     <span class="ruby-value">:tAMPER</span>
                   <span class="ruby-keyword">else</span>
                     <span class="ruby-value">:tAMPER2</span>
                   <span class="ruby-keyword">end</span>

          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;&amp;&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\//</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_beg?</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_strterm</span> = [<span class="ruby-value">:strterm</span>, <span class="ruby-constant">STR_REGEXP</span>, <span class="ruby-string">'/'</span>, <span class="ruby-string">&quot;\00&quot;&quot;</span>]
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;/&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tREGEXP_BEG</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;/&quot;</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tOP_ASGN</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_arg?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">space_seen</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">unless</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\s/</span>) <span class="ruby-keyword">then</span>
            <span class="ruby-identifier">arg_ambiguous</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_strterm</span> = [<span class="ruby-value">:strterm</span>, <span class="ruby-constant">STR_REGEXP</span>, <span class="ruby-string">'/'</span>, <span class="ruby-string">&quot;\00&quot;&quot;</span>]
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;/&quot;</span>
            <span class="ruby-keyword">return</span> <span class="ruby-value">:tREGEXP_BEG</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;/&quot;</span>

        <span class="ruby-keyword">return</span> <span class="ruby-value">:tDIVIDE</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\^=/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;^&quot;</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tOP_ASGN</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\^/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;^&quot;</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tCARET</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\;/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">command_start</span> = <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;;&quot;</span>
        <span class="ruby-keyword">return</span> <span class="ruby-value">:tSEMI</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\~/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_fname</span>, <span class="ruby-value">:expr_dot</span> <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/@/</span>)
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;~&quot;</span>

        <span class="ruby-keyword">return</span> <span class="ruby-value">:tTILDE</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\r?\n/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lineno</span> = <span class="ruby-keyword">nil</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">space_seen</span> = <span class="ruby-keyword">true</span>
          <span class="ruby-keyword">next</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-string">&quot;bare backslash only allowed before newline&quot;</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\%/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_beg?</span> <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">parse_quote</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\=/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_beg</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;%&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tOP_ASGN</span>
        <span class="ruby-keyword">end</span>

        <span class="ruby-keyword">return</span> <span class="ruby-identifier">parse_quote</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_arg?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">space_seen</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\s/</span>)

        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">fix_arg_lex_state</span>
        <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;%&quot;</span>

        <span class="ruby-keyword">return</span> <span class="ruby-value">:tPERCENT</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\$/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/(\$_)(\w+)/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">token</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">process_token</span>(<span class="ruby-identifier">command_state</span>)
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\$_/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">token</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tGVAR</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\$[~*$?!@\/\;,.=:&lt;&gt;\&quot;]|\$-\w?/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
          <span class="ruby-keyword">return</span> <span class="ruby-value">:tGVAR</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\$([\&amp;\`\\+])/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
          <span class="ruby-comment"># Explicit reference to these vars as symbols...</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_state</span> <span class="ruby-operator">==</span> <span class="ruby-value">:expr_fname</span> <span class="ruby-keyword">then</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
            <span class="ruby-keyword">return</span> <span class="ruby-value">:tGVAR</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_sym</span>
            <span class="ruby-keyword">return</span> <span class="ruby-value">:tBACK_REF</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\$([1-9]\d*)/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
          <span class="ruby-keyword">if</span> <span class="ruby-identifier">last_state</span> <span class="ruby-operator">==</span> <span class="ruby-value">:expr_fname</span> <span class="ruby-keyword">then</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
            <span class="ruby-keyword">return</span> <span class="ruby-value">:tGVAR</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-identifier">src</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_i</span>
            <span class="ruby-keyword">return</span> <span class="ruby-value">:tNTH_REF</span>
          <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\$0/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">token</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">process_token</span>(<span class="ruby-identifier">command_state</span>)
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\$\W|\$\z/</span>) <span class="ruby-keyword">then</span> <span class="ruby-comment"># TODO: remove?</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">yacc_value</span> = <span class="ruby-string">&quot;$&quot;</span>
          <span class="ruby-keyword">return</span> <span class="ruby-string">&quot;$&quot;</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\$\w+/</span>)
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span> = <span class="ruby-value">:expr_end</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">token</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">process_token</span>(<span class="ruby-identifier">command_state</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span>(<span class="ruby-regexp">/\_/</span>) <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">beginning_of_line?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\__END__(\r?\n|\Z)/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lineno</span> = <span class="ruby-keyword">nil</span>
          <span class="ruby-keyword">return</span> <span class="ruby-constant">RubyLexer</span><span class="ruby-operator">::</span><span class="ruby-constant">EOF</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\_\w*/</span>) <span class="ruby-keyword">then</span>
          <span class="ruby-keyword">self</span>.<span class="ruby-identifier">token</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span>
          <span class="ruby-keyword">return</span> <span class="ruby-identifier">process_token</span>(<span class="ruby-identifier">command_state</span>)
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span> <span class="ruby-comment"># END OF CASE</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span>(<span class="ruby-regexp">/\004|\032|\000/</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">src</span>.<span class="ruby-identifier">eos?</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># ^D, ^Z, EOF</span>
      <span class="ruby-keyword">return</span> <span class="ruby-constant">RubyLexer</span><span class="ruby-operator">::</span><span class="ruby-constant">EOF</span>
    <span class="ruby-keyword">else</span> <span class="ruby-comment"># alpha check</span>
      <span class="ruby-identifier">rb_compile_error</span> <span class="ruby-node">&quot;Invalid char #{src.rest[0].chr} in expression&quot;</span> <span class="ruby-keyword">unless</span>
        <span class="ruby-identifier">src</span>.<span class="ruby-identifier">check</span> <span class="ruby-constant">IDENT_RE</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">token</span> = <span class="ruby-identifier">src</span>.<span class="ruby-identifier">matched</span> <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">src</span>.<span class="ruby-identifier">scan</span> <span class="ruby-constant">IDENT_RE</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">process_token</span>(<span class="ruby-identifier">command_state</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- yylex-source -->
          
        </div>

        

        
      </div><!-- yylex-method -->

    
      <div id="method-i-yylex_paren18" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">yylex_paren18</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="yylex_paren18-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 1333</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">yylex_paren18</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">command_start</span> = <span class="ruby-keyword">true</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-value">:tLPAREN2</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_beg</span>, <span class="ruby-value">:expr_mid</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-value">:tLPAREN</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">space_seen</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_cmdarg</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span> = <span class="ruby-value">:tLPAREN_ARG</span>
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">in_lex_state?</span> <span class="ruby-value">:expr_arg</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tern</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">false</span>
      <span class="ruby-identifier">warning</span> <span class="ruby-string">&quot;don't put space before argument parentheses&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">tern</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- yylex_paren18-source -->
          
        </div>

        

        
      </div><!-- yylex_paren18-method -->

    
      <div id="method-i-yylex_paren19" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">yylex_paren19</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="yylex_paren19-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 1353</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">yylex_paren19</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">is_beg?</span> <span class="ruby-keyword">then</span>
    <span class="ruby-value">:tLPAREN</span>
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">is_space_arg?</span> <span class="ruby-keyword">then</span>
    <span class="ruby-value">:tLPAREN_ARG</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-value">:tLPAREN2</span> <span class="ruby-comment"># plain '(' in parse.y</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- yylex_paren19-source -->
          
        </div>

        

        
      </div><!-- yylex_paren19-method -->

    
      <div id="method-i-yylex_string" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">yylex_string</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="yylex_string-source">
            <pre><span class="ruby-comment"># File lib/ruby_lexer.rb, line 1502</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">yylex_string</span> <span class="ruby-comment"># 23 lines</span>
  <span class="ruby-identifier">token</span> = <span class="ruby-keyword">if</span> <span class="ruby-identifier">lex_strterm</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:heredoc</span> <span class="ruby-keyword">then</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">heredoc</span> <span class="ruby-identifier">lex_strterm</span>
          <span class="ruby-keyword">else</span>
            <span class="ruby-keyword">self</span>.<span class="ruby-identifier">parse_string</span> <span class="ruby-identifier">lex_strterm</span>
          <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">token</span> <span class="ruby-operator">==</span> <span class="ruby-value">:tSTRING_END</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">token</span> <span class="ruby-operator">==</span> <span class="ruby-value">:tREGEXP_END</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lineno</span>      = <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_strterm</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lex_state</span>   = <span class="ruby-value">:expr_end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">token</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- yylex_string-source -->
          
        </div>

        

        
      </div><!-- yylex_string-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.2.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>


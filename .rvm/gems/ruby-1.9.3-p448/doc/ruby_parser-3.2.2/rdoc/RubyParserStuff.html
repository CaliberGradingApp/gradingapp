<!DOCTYPE html>

<html>
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">

<title>module RubyParserStuff - ruby_parser-3.2.2 Documentation</title>

<link type="text/css" media="screen" href="./rdoc.css" rel="stylesheet">

<script type="text/javascript">
  var rdoc_rel_prefix = "./";
</script>

<script type="text/javascript" charset="utf-8" src="./js/jquery.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/navigation.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search_index.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/search.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/searcher.js"></script>
<script type="text/javascript" charset="utf-8" src="./js/darkfish.js"></script>


<body id="top" class="module">
<nav id="metadata">
  <nav id="home-section" class="section">
  <h3 class="section-header">
    <a href="./index.html">Home</a>
    <a href="./table_of_contents.html#classes">Classes</a>
    <a href="./table_of_contents.html#methods">Methods</a>
  </h3>
</nav>


  <nav id="search-section" class="section project-section" class="initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <h3 class="section-header">
      <input type="text" name="search" placeholder="Search" id="search-field"
             title="Type to search, Up and Down to navigate, Enter to load">
    </h3>
  </form>

  <ul id="search-results" class="initially-hidden"></ul>
</nav>


  <div id="file-metadata">
    <nav id="file-list-section" class="section">
  <h3 class="section-header">Defined In</h3>
  <ul>
    <li>lib/ruby_parser_extras.rb
  </ul>
</nav>

    
  </div>

  <div id="class-metadata">
    
    
    
    <!-- Method Quickref -->
<nav id="method-list-section" class="section">
  <h3 class="section-header">Methods</h3>

  <ul class="link-list">
    
    <li><a href="#method-c-new">::new</a>
    
    <li><a href="#method-i-arg_add">#arg_add</a>
    
    <li><a href="#method-i-arg_blk_pass">#arg_blk_pass</a>
    
    <li><a href="#method-i-arg_concat">#arg_concat</a>
    
    <li><a href="#method-i-argl">#argl</a>
    
    <li><a href="#method-i-args">#args</a>
    
    <li><a href="#method-i-array_to_hash">#array_to_hash</a>
    
    <li><a href="#method-i-aryset">#aryset</a>
    
    <li><a href="#method-i-assignable">#assignable</a>
    
    <li><a href="#method-i-backref_assign_error">#backref_assign_error</a>
    
    <li><a href="#method-i-block_append">#block_append</a>
    
    <li><a href="#method-i-block_dup_check">#block_dup_check</a>
    
    <li><a href="#method-i-block_var">#block_var</a>
    
    <li><a href="#method-i-block_var18">#block_var18</a>
    
    <li><a href="#method-i-call_args">#call_args</a>
    
    <li><a href="#method-i-clean_mlhs">#clean_mlhs</a>
    
    <li><a href="#method-i-cond">#cond</a>
    
    <li><a href="#method-i-debug20">#debug20</a>
    
    <li><a href="#method-i-do_parse">#do_parse</a>
    
    <li><a href="#method-i-get_match_node">#get_match_node</a>
    
    <li><a href="#method-i-gettable">#gettable</a>
    
    <li><a href="#method-i-hack_encoding">#hack_encoding</a>
    
    <li><a href="#method-i-handle_encoding">#handle_encoding</a>
    
    <li><a href="#method-i-list_append">#list_append</a>
    
    <li><a href="#method-i-list_prepend">#list_prepend</a>
    
    <li><a href="#method-i-literal_concat">#literal_concat</a>
    
    <li><a href="#method-i-logop">#logop</a>
    
    <li><a href="#method-i-new_aref">#new_aref</a>
    
    <li><a href="#method-i-new_body">#new_body</a>
    
    <li><a href="#method-i-new_call">#new_call</a>
    
    <li><a href="#method-i-new_case">#new_case</a>
    
    <li><a href="#method-i-new_class">#new_class</a>
    
    <li><a href="#method-i-new_compstmt">#new_compstmt</a>
    
    <li><a href="#method-i-new_defn">#new_defn</a>
    
    <li><a href="#method-i-new_defs">#new_defs</a>
    
    <li><a href="#method-i-new_for">#new_for</a>
    
    <li><a href="#method-i-new_if">#new_if</a>
    
    <li><a href="#method-i-new_iter">#new_iter</a>
    
    <li><a href="#method-i-new_masgn">#new_masgn</a>
    
    <li><a href="#method-i-new_module">#new_module</a>
    
    <li><a href="#method-i-new_op_asgn">#new_op_asgn</a>
    
    <li><a href="#method-i-new_regexp">#new_regexp</a>
    
    <li><a href="#method-i-new_resbody">#new_resbody</a>
    
    <li><a href="#method-i-new_sclass">#new_sclass</a>
    
    <li><a href="#method-i-new_super">#new_super</a>
    
    <li><a href="#method-i-new_undef">#new_undef</a>
    
    <li><a href="#method-i-new_until">#new_until</a>
    
    <li><a href="#method-i-new_until_or_while">#new_until_or_while</a>
    
    <li><a href="#method-i-new_when">#new_when</a>
    
    <li><a href="#method-i-new_while">#new_while</a>
    
    <li><a href="#method-i-new_xstring">#new_xstring</a>
    
    <li><a href="#method-i-new_yield">#new_yield</a>
    
    <li><a href="#method-i-next_token">#next_token</a>
    
    <li><a href="#method-i-node_assign">#node_assign</a>
    
    <li><a href="#method-i-on_error">#on_error</a>
    
    <li><a href="#method-i-process">#process</a>
    
    <li><a href="#method-i-remove_begin">#remove_begin</a>
    
    <li><a href="#method-i-reset">#reset</a>
    
    <li><a href="#method-i-ret_args">#ret_args</a>
    
    <li><a href="#method-i-s">#s</a>
    
    <li><a href="#method-i-syntax_error">#syntax_error</a>
    
    <li><a href="#method-i-value_expr">#value_expr</a>
    
    <li><a href="#method-i-void_stmts">#void_stmts</a>
    
    <li><a href="#method-i-warning">#warning</a>
    
  </ul>
</nav>

  </div>

  <div id="project-metadata">
    <nav id="fileindex-section" class="section project-section">
  <h3 class="section-header">Pages</h3>

  <ul>
  
    <li class="file"><a href="./History_txt.html">History</a>
  
    <li class="file"><a href="./Manifest_txt.html">Manifest</a>
  
    <li class="file"><a href="./README_txt.html">README</a>
  
  </ul>
</nav>

    <nav id="classindex-section" class="section project-section">
  <h3 class="section-header">Class and Module Index</h3>

  <ul class="link-list">
  
    <li><a href="./RubyParserStuff.html">RubyParserStuff</a>
  
    <li><a href="./RubyParserStuff/Environment.html">RubyParserStuff::Environment</a>
  
    <li><a href="./RubyParserStuff/Keyword.html">RubyParserStuff::Keyword</a>
  
    <li><a href="./RubyParserStuff/Keyword/KWtable.html">RubyParserStuff::Keyword::KWtable</a>
  
    <li><a href="./RubyParserStuff/Ruby18Parser.html">RubyParserStuff::Ruby18Parser</a>
  
    <li><a href="./RubyParserStuff/Ruby19Parser.html">RubyParserStuff::Ruby19Parser</a>
  
    <li><a href="./RubyParserStuff/Ruby20Parser.html">RubyParserStuff::Ruby20Parser</a>
  
    <li><a href="./RubyParserStuff/RubyParser.html">RubyParserStuff::RubyParser</a>
  
    <li><a href="./RubyParserStuff/RubyParser/SyntaxError.html">RubyParserStuff::RubyParser::SyntaxError</a>
  
    <li><a href="./RubyParserStuff/Sexp.html">RubyParserStuff::Sexp</a>
  
    <li><a href="./RubyParserStuff/StackState.html">RubyParserStuff::StackState</a>
  
    <li><a href="./RubyParserStuff/String.html">RubyParserStuff::String</a>
  
    <li><a href="./RPStringScanner.html">RPStringScanner</a>
  
    <li><a href="./Ruby18Parser.html">Ruby18Parser</a>
  
    <li><a href="./Ruby19Parser.html">Ruby19Parser</a>
  
    <li><a href="./Ruby20Parser.html">Ruby20Parser</a>
  
    <li><a href="./RubyLexer.html">RubyLexer</a>
  
    <li><a href="./RubyParserGauntlet.html">RubyParserGauntlet</a>
  
  </ul>
</nav>

  </div>
</nav>

<div id="documentation">
  <h1 class="module">module RubyParserStuff</h1>

  <div id="description" class="description">
    
  </div><!-- description -->

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    
    <!-- Constants -->
    <section id="constants-list" class="section">
      <h3 class="section-header">Constants</h3>
      <dl>
      
        <dt id="ENCODING_ORDER">ENCODING_ORDER
        
        <dd class="description"><p>Rhis is in sorted order of occurrence according to charlock_holmes against
500k files, with UTF_8 forced to the top.</p>

<p>Overwrite this contstant if you need something different.</p>
        
      
        <dt id="VERSION">VERSION
        
        <dd class="description">
        
      
      </dl>
    </section>
    

    
    <!-- Attributes -->
    <section id="attribute-method-details" class="method-section section">
      <h3 class="section-header">Attributes</h3>

      
      <div id="attribute-i-canonicalize_conditions" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">canonicalize_conditions</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        <p>Canonicalize conditionals. Eg:</p>

<pre>not x ? a : b</pre>

<p>becomes:</p>

<pre>x ? b : a</pre>
        
        </div>
      </div>
      
      <div id="attribute-i-comments" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">comments</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-env" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">env</span><span
            class="attribute-access-type">[R]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-file" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">file</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-in_def" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">in_def</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-in_single" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">in_single</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
      <div id="attribute-i-lexer" class="method-detail">
        <div class="method-heading attribute-method-heading">
          <span class="method-name">lexer</span><span
            class="attribute-access-type">[RW]</span>
        </div>

        <div class="method-description">
        
        
        
        </div>
      </div>
      
    </section><!-- attribute-method-details -->
    

    <!-- Methods -->
    
     <section id="public-class-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Class Methods</h3>

    
      <div id="method-c-new" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new</span><span
            class="method-args">(options = {})</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 442</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">options</span> = {})
  <span class="ruby-keyword">super</span>()

  <span class="ruby-identifier">v</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">name</span>[<span class="ruby-regexp">/1[89]/</span>]
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span> = <span class="ruby-constant">RubyLexer</span>.<span class="ruby-identifier">new</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">v</span>.<span class="ruby-identifier">to_i</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">parser</span> = <span class="ruby-keyword">self</span>
  <span class="ruby-ivar">@env</span> = <span class="ruby-constant">RubyParserStuff</span><span class="ruby-operator">::</span><span class="ruby-constant">Environment</span>.<span class="ruby-identifier">new</span>
  <span class="ruby-ivar">@comments</span> = []

  <span class="ruby-ivar">@canonicalize_conditions</span> = <span class="ruby-keyword">true</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">reset</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new-source -->
          
        </div>

        

        
      </div><!-- new-method -->

    
    </section><!-- public-class-method-details -->
  
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section section">
      <h3 class="section-header">Public Instance Methods</h3>

    
      <div id="method-i-arg_add" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">arg_add</span><span
            class="method-args">(node1, node2)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="arg_add-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 150</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">arg_add</span>(<span class="ruby-identifier">node1</span>, <span class="ruby-identifier">node2</span>) <span class="ruby-comment"># TODO: nuke</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">node2</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node1</span>

  <span class="ruby-identifier">node1</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:arglist</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node1</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">node1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node2</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node1</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:arglist</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">node1</span>, <span class="ruby-identifier">node2</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- arg_add-source -->
          
        </div>

        

        
      </div><!-- arg_add-method -->

    
      <div id="method-i-arg_blk_pass" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">arg_blk_pass</span><span
            class="method-args">(node1, node2)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="arg_blk_pass-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 159</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">arg_blk_pass</span> <span class="ruby-identifier">node1</span>, <span class="ruby-identifier">node2</span> <span class="ruby-comment"># TODO: nuke</span>
  <span class="ruby-identifier">node1</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">node1</span>) <span class="ruby-keyword">unless</span> [<span class="ruby-value">:arglist</span>, <span class="ruby-value">:call_args</span>, <span class="ruby-value">:array</span>, <span class="ruby-value">:args</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">node1</span>.<span class="ruby-identifier">first</span>
  <span class="ruby-identifier">node1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">node2</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node2</span>
  <span class="ruby-identifier">node1</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- arg_blk_pass-source -->
          
        </div>

        

        
      </div><!-- arg_blk_pass-method -->

    
      <div id="method-i-arg_concat" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">arg_concat</span><span
            class="method-args">(node1, node2)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="arg_concat-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 165</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">arg_concat</span> <span class="ruby-identifier">node1</span>, <span class="ruby-identifier">node2</span> <span class="ruby-comment"># TODO: nuke</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;huh&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node2</span>
  <span class="ruby-identifier">node1</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:splat</span>, <span class="ruby-identifier">node2</span>).<span class="ruby-identifier">compact</span>
  <span class="ruby-identifier">node1</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- arg_concat-source -->
          
        </div>

        

        
      </div><!-- arg_concat-method -->

    
      <div id="method-i-argl" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">argl</span><span
            class="method-args">(x)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="argl-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 572</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">argl</span> <span class="ruby-identifier">x</span>
  <span class="ruby-identifier">x</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">x</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">x</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">x</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">!=</span> <span class="ruby-value">:arglist</span>
  <span class="ruby-identifier">x</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- argl-source -->
          
        </div>

        

        
      </div><!-- argl-method -->

    
      <div id="method-i-args" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">args</span><span
            class="method-args">(args)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="args-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 248</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">args</span> <span class="ruby-identifier">args</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:args</span>)

  <span class="ruby-identifier">args</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">arg</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Sexp</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">case</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">sexp_type</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:args</span>, <span class="ruby-value">:block</span>, <span class="ruby-value">:array</span>, <span class="ruby-value">:call_args</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># HACK call_args mismatch</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">arg</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
      <span class="ruby-keyword">when</span> <span class="ruby-value">:block_arg</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-value">:&quot;&amp;#{arg.last}&quot;</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:shadow</span> <span class="ruby-keyword">then</span>
        <span class="ruby-keyword">if</span> <span class="ruby-constant">Sexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">last</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">sexp_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:shadow</span> <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">result</span>.<span class="ruby-identifier">last</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">last</span>
        <span class="ruby-keyword">else</span>
          <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:masgn</span>, <span class="ruby-value">:block_pass</span>, <span class="ruby-value">:hash</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># HACK: remove. prolly call_args</span>
        <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unhandled: #{arg.sexp_type} in #{args.inspect}&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Symbol</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;,&quot;</span>, <span class="ruby-string">&quot;|&quot;</span>, <span class="ruby-string">&quot;;&quot;</span>, <span class="ruby-string">&quot;(&quot;</span>, <span class="ruby-string">&quot;)&quot;</span>, <span class="ruby-keyword">nil</span> <span class="ruby-keyword">then</span>
      <span class="ruby-comment"># ignore</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unhandled: #{arg.inspect} in #{args.inspect}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- args-source -->
          
        </div>

        

        
      </div><!-- args-method -->

    
      <div id="method-i-array_to_hash" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">array_to_hash</span><span
            class="method-args">(array)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="array_to_hash-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 215</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">array_to_hash</span> <span class="ruby-identifier">array</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">array</span>.<span class="ruby-identifier">sexp_type</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:kwsplat</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">array</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:hash</span>, *<span class="ruby-identifier">array</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- array_to_hash-source -->
          
        </div>

        

        
      </div><!-- array_to_hash-method -->

    
      <div id="method-i-aryset" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">aryset</span><span
            class="method-args">(receiver, index)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="aryset-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 282</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">aryset</span> <span class="ruby-identifier">receiver</span>, <span class="ruby-identifier">index</span>
  <span class="ruby-identifier">index</span> <span class="ruby-operator">||=</span> []
  <span class="ruby-identifier">s</span>(<span class="ruby-value">:attrasgn</span>, <span class="ruby-identifier">receiver</span>, <span class="ruby-value">:&quot;[]=&quot;</span>, *<span class="ruby-identifier">index</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
<span class="ruby-keyword">end</span></pre>
          </div><!-- aryset-source -->
          
        </div>

        

        
      </div><!-- aryset-method -->

    
      <div id="method-i-assignable" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">assignable</span><span
            class="method-args">(lhs, value = nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="assignable-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 287</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">assignable</span>(<span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">value</span> = <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">id</span> = <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">to_sym</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">Sexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lhs</span>
  <span class="ruby-identifier">id</span> = <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_sym</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">Sexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">id</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 1&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^(?:self|nil|true|false|__LINE__|__FILE__)$/</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-node">&quot;Can't change the value of #{id}&quot;</span> <span class="ruby-keyword">if</span>
    <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/^(?:self|nil|true|false|__LINE__|__FILE__)$/</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^@@/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">asgn</span> = <span class="ruby-identifier">in_def</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">in_single</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">0</span>
             <span class="ruby-identifier">s</span>((<span class="ruby-identifier">asgn</span> <span class="ruby-operator">?</span> <span class="ruby-value">:cvasgn</span> <span class="ruby-operator">:</span> <span class="ruby-value">:cvdecl</span>), <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^@/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:iasgn</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^\$/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:gasgn</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^[A-Z]/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:cdecl</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">else</span>
             <span class="ruby-keyword">case</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>[<span class="ruby-identifier">id</span>]
             <span class="ruby-keyword">when</span> <span class="ruby-value">:lvar</span> <span class="ruby-keyword">then</span>
               <span class="ruby-identifier">s</span>(<span class="ruby-value">:lasgn</span>, <span class="ruby-identifier">id</span>)
             <span class="ruby-keyword">when</span> <span class="ruby-value">:dvar</span>, <span class="ruby-keyword">nil</span> <span class="ruby-keyword">then</span>
               <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">id</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:dvar</span> <span class="ruby-keyword">then</span>
                 <span class="ruby-identifier">s</span>(<span class="ruby-value">:lasgn</span>, <span class="ruby-identifier">id</span>)
               <span class="ruby-keyword">elsif</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>[<span class="ruby-identifier">id</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:dvar</span> <span class="ruby-keyword">then</span>
                 <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">use</span>(<span class="ruby-identifier">id</span>)
                 <span class="ruby-identifier">s</span>(<span class="ruby-value">:lasgn</span>, <span class="ruby-identifier">id</span>)
               <span class="ruby-keyword">elsif</span> <span class="ruby-operator">!</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">dynamic?</span> <span class="ruby-keyword">then</span>
                 <span class="ruby-identifier">s</span>(<span class="ruby-value">:lasgn</span>, <span class="ruby-identifier">id</span>)
               <span class="ruby-keyword">else</span>
                 <span class="ruby-identifier">s</span>(<span class="ruby-value">:lasgn</span>, <span class="ruby-identifier">id</span>)
               <span class="ruby-keyword">end</span>
             <span class="ruby-keyword">else</span>
               <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;wtf? unknown type: #{self.env[id]}&quot;</span>
             <span class="ruby-keyword">end</span>
           <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>[<span class="ruby-identifier">id</span>] <span class="ruby-operator">||=</span> <span class="ruby-value">:lvar</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">sexp_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:cdecl</span> <span class="ruby-comment"># HACK? cdecl</span>

  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">value</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">value</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- assignable-source -->
          
        </div>

        

        
      </div><!-- assignable-method -->

    
      <div id="method-i-backref_assign_error" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">backref_assign_error</span><span
            class="method-args">(ref)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="backref_assign_error-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 577</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">backref_assign_error</span> <span class="ruby-identifier">ref</span>
  <span class="ruby-comment"># TODO: need a test for this... obviously</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">first</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:nth_ref</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 2&quot;</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;Can't set variable %p&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">last</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:back_ref</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 3&quot;</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;Can't set back reference %p&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">last</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Unknown backref type: #{ref.inspect}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- backref_assign_error-source -->
          
        </div>

        

        
      </div><!-- backref_assign_error-method -->

    
      <div id="method-i-block_append" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">block_append</span><span
            class="method-args">(head, tail)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="block_append-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 333</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">block_append</span>(<span class="ruby-identifier">head</span>, <span class="ruby-identifier">tail</span>)
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">head</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tail</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">tail</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">head</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-identifier">line</span> = [<span class="ruby-identifier">head</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">tail</span>.<span class="ruby-identifier">line</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>

  <span class="ruby-identifier">head</span> = <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">head</span>)
  <span class="ruby-identifier">head</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:block</span>, <span class="ruby-identifier">head</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">head</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span>

  <span class="ruby-identifier">head</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">head</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tail</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- block_append-source -->
          
        </div>

        

        
      </div><!-- block_append-method -->

    
      <div id="method-i-block_dup_check" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">block_dup_check</span><span
            class="method-args">(call_or_args, block)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="block_dup_check-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1064</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">block_dup_check</span> <span class="ruby-identifier">call_or_args</span>, <span class="ruby-identifier">block</span>
  <span class="ruby-identifier">syntax_error</span> <span class="ruby-string">&quot;Both block arg and actual block given.&quot;</span> <span class="ruby-keyword">if</span>
    <span class="ruby-identifier">block</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">call_or_args</span>.<span class="ruby-identifier">block_pass?</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- block_dup_check-source -->
          
        </div>

        

        
      </div><!-- block_dup_check-method -->

    
      <div id="method-i-block_var" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">block_var</span><span
            class="method-args">(*args)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="block_var-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 192</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">block_var</span> *<span class="ruby-identifier">args</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">args</span> <span class="ruby-identifier">args</span>
  <span class="ruby-identifier">result</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:masgn</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- block_var-source -->
          
        </div>

        

        
      </div><!-- block_var-method -->

    
      <div id="method-i-block_var18" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">block_var18</span><span
            class="method-args">(ary, splat, block)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="block_var18-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 198</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">block_var18</span> <span class="ruby-identifier">ary</span>, <span class="ruby-identifier">splat</span>, <span class="ruby-identifier">block</span>
  <span class="ruby-identifier">ary</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:array</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">splat</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">splat</span> = <span class="ruby-identifier">splat</span>[<span class="ruby-value">1</span>] <span class="ruby-keyword">unless</span> <span class="ruby-constant">Symbol</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">splat</span>
    <span class="ruby-identifier">ary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;*#{splat}&quot;</span>.<span class="ruby-identifier">to_sym</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">ary</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot;&amp;#{block[1]}&quot;</span>.<span class="ruby-identifier">to_sym</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">ary</span>.<span class="ruby-identifier">length</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">2</span> <span class="ruby-keyword">or</span> <span class="ruby-identifier">ary</span>.<span class="ruby-identifier">splat</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># HACK</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:masgn</span>, *<span class="ruby-identifier">ary</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">ary</span>.<span class="ruby-identifier">last</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- block_var18-source -->
          
        </div>

        

        
      </div><!-- block_var18-method -->

    
      <div id="method-i-call_args" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">call_args</span><span
            class="method-args">(args)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="call_args-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 224</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">call_args</span> <span class="ruby-identifier">args</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:call_args</span>)

  <span class="ruby-identifier">args</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">arg</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">arg</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Sexp</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">case</span> <span class="ruby-identifier">arg</span>.<span class="ruby-identifier">sexp_type</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:array</span>, <span class="ruby-value">:args</span>, <span class="ruby-value">:call_args</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># HACK? remove array at some point</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">arg</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-constant">Symbol</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
    <span class="ruby-keyword">when</span> <span class="ruby-string">&quot;,&quot;</span>, <span class="ruby-keyword">nil</span> <span class="ruby-keyword">then</span>
      <span class="ruby-comment"># ignore</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unhandled: #{arg.inspect} in #{args.inspect}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- call_args-source -->
          
        </div>

        

        
      </div><!-- call_args-method -->

    
      <div id="method-i-clean_mlhs" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">clean_mlhs</span><span
            class="method-args">(sexp)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="clean_mlhs-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 171</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">clean_mlhs</span> <span class="ruby-identifier">sexp</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">sexp</span>.<span class="ruby-identifier">sexp_type</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:masgn</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">sexp</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">sexp</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">sexp_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:array</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">s</span>(<span class="ruby-value">:masgn</span>, *<span class="ruby-identifier">sexp</span>[<span class="ruby-value">1</span>][<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">sub</span><span class="ruby-operator">|</span> <span class="ruby-identifier">clean_mlhs</span> <span class="ruby-identifier">sub</span> })
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">debug20</span> <span class="ruby-value">5</span>
      <span class="ruby-identifier">sexp</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:gasgn</span>, <span class="ruby-value">:iasgn</span>, <span class="ruby-value">:lasgn</span>, <span class="ruby-value">:cvasgn</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">sexp</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">sexp</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">debug20</span> <span class="ruby-value">7</span>
      <span class="ruby-identifier">sexp</span> <span class="ruby-comment"># optional value</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unsupported type: #{sexp.inspect}&quot;</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- clean_mlhs-source -->
          
        </div>

        

        
      </div><!-- clean_mlhs-method -->

    
      <div id="method-i-cond" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">cond</span><span
            class="method-args">(node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="cond-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 346</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">cond</span> <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">nil?</span>
  <span class="ruby-identifier">node</span> = <span class="ruby-identifier">value_expr</span> <span class="ruby-identifier">node</span>

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">first</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:lit</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-constant">Regexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">last</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:match</span>, <span class="ruby-identifier">node</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">node</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:and</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:and</span>, <span class="ruby-identifier">cond</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>]), <span class="ruby-identifier">cond</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>]))
  <span class="ruby-keyword">when</span> <span class="ruby-value">:or</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:or</span>,  <span class="ruby-identifier">cond</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>]), <span class="ruby-identifier">cond</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>]))
  <span class="ruby-keyword">when</span> <span class="ruby-value">:dot2</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">label</span> = <span class="ruby-node">&quot;flip#{node.hash}&quot;</span>
    <span class="ruby-identifier">env</span>[<span class="ruby-identifier">label</span>] = <span class="ruby-value">:lvar</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:flip2</span>, <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>])
  <span class="ruby-keyword">when</span> <span class="ruby-value">:dot3</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">label</span> = <span class="ruby-node">&quot;flip#{node.hash}&quot;</span>
    <span class="ruby-identifier">env</span>[<span class="ruby-identifier">label</span>] = <span class="ruby-value">:lvar</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:flip3</span>, <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>])
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- cond-source -->
          
        </div>

        

        
      </div><!-- cond-method -->

    
      <div id="method-i-debug20" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">debug20</span><span
            class="method-args">(n, v = nil, r = nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="debug20-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 125</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">debug20</span> <span class="ruby-identifier">n</span>, <span class="ruby-identifier">v</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">r</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;not yet #{n} #{v.inspect} =&gt; #{r.inspect}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">$good20</span>[<span class="ruby-identifier">n</span>]
<span class="ruby-keyword">end</span></pre>
          </div><!-- debug20-source -->
          
        </div>

        

        
      </div><!-- debug20-method -->

    
      <div id="method-i-do_parse" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">do_parse</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>for pure ruby systems only</p>
          

          
          <div class="method-source-code" id="do_parse-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 377</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">do_parse</span>
  <span class="ruby-identifier">_racc_do_parse_rb</span>(<span class="ruby-identifier">_racc_setup</span>, <span class="ruby-keyword">false</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- do_parse-source -->
          
        </div>

        

        
      </div><!-- do_parse-method -->

    
      <div id="method-i-get_match_node" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">get_match_node</span><span
            class="method-args">(lhs, rhs)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="get_match_node-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 381</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_match_node</span> <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span> <span class="ruby-comment"># TODO: rename to new_match</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">lhs</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">lhs</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-value">:dregx</span>, <span class="ruby-value">:dregx_once</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:match2</span>, <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-value">:lit</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:match2</span>, <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">Regexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">rhs</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">rhs</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-value">:dregx</span>, <span class="ruby-value">:dregx_once</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:match3</span>, <span class="ruby-identifier">rhs</span>, <span class="ruby-identifier">lhs</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>)
    <span class="ruby-keyword">when</span> <span class="ruby-value">:lit</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:match3</span>, <span class="ruby-identifier">rhs</span>, <span class="ruby-identifier">lhs</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">Regexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">rhs</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">new_call</span>(<span class="ruby-identifier">lhs</span>, <span class="ruby-value">:&quot;=~&quot;</span>, <span class="ruby-identifier">argl</span>(<span class="ruby-identifier">rhs</span>)).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- get_match_node-source -->
          
        </div>

        

        
      </div><!-- get_match_node-method -->

    
      <div id="method-i-gettable" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">gettable</span><span
            class="method-args">(id)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="gettable-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 403</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">id</span>)
  <span class="ruby-identifier">id</span> = <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_sym</span> <span class="ruby-keyword">if</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">id</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^@@/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:cvar</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^@/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:ivar</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^\$/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:gvar</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-regexp">/^[A-Z]/</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:const</span>, <span class="ruby-identifier">id</span>)
           <span class="ruby-keyword">else</span>
             <span class="ruby-identifier">type</span> = <span class="ruby-identifier">env</span>[<span class="ruby-identifier">id</span>]
             <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span> <span class="ruby-keyword">then</span>
               <span class="ruby-identifier">s</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">id</span>)
             <span class="ruby-keyword">else</span>
               <span class="ruby-identifier">new_call</span>(<span class="ruby-keyword">nil</span>, <span class="ruby-identifier">id</span>)
             <span class="ruby-keyword">end</span>
           <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span>(<span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> <span class="ruby-operator">-</span> <span class="ruby-value">1</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">src</span>.<span class="ruby-identifier">bol?</span>

  <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;identifier #{id.inspect} is not valid&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">result</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- gettable-source -->
          
        </div>

        

        
      </div><!-- gettable-method -->

    
      <div id="method-i-hack_encoding" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">hack_encoding</span><span
            class="method-args">(str, extra = nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="hack_encoding-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1002</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">hack_encoding</span> <span class="ruby-identifier">str</span>, <span class="ruby-identifier">extra</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">encodings</span> = <span class="ruby-constant">ENCODING_ORDER</span>.<span class="ruby-identifier">dup</span>
  <span class="ruby-identifier">encodings</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">extra</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">extra</span>.<span class="ruby-identifier">nil?</span>

  <span class="ruby-comment"># terrible, horrible, no good, very bad, last ditch effort.</span>
  <span class="ruby-identifier">encodings</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">enc</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">begin</span>
      <span class="ruby-identifier">str</span>.<span class="ruby-identifier">force_encoding</span> <span class="ruby-identifier">enc</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">valid_encoding?</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">str</span>.<span class="ruby-identifier">encode!</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">UTF_8</span>
        <span class="ruby-keyword">break</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">InvalidByteSequenceError</span>
      <span class="ruby-comment"># do nothing</span>
    <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">UndefinedConversionError</span>
      <span class="ruby-comment"># do nothing</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># no amount of pain is enough for you.</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Bad encoding. Need a magic encoding comment.&quot;</span> <span class="ruby-keyword">unless</span>
    <span class="ruby-identifier">str</span>.<span class="ruby-identifier">encoding</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;UTF-8&quot;</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- hack_encoding-source -->
          
        </div>

        

        
      </div><!-- hack_encoding-method -->

    
      <div id="method-i-handle_encoding" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">handle_encoding</span><span
            class="method-args">(str)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Returns a UTF-8 encoded string after processing BOMs and magic encoding
comments.</p>

<p>Holy crap ok. Here goes:</p>

<p>Rubys file handling and encoding support is insane. We need to be able to
lex a file. The lexer file is explicitly UTF-8 to make things cleaner. This
allows us to deal with extended chars in class and method names. In order
to do this, we need to encode all input source files as UTF-8. First, we
look for a UTF-8 BOM by looking at the first line while forcing its
encoding to ASCII-8BIT. If we find a BOM, we strip it and set the expected
encoding to UTF-8. Then, we search for a magic encoding comment. If found,
it overrides the BOM. Finally, we force the encoding of the input string to
whatever was found, and then encode that to UTF-8 for compatibility with
the lexer.</p>
          

          
          <div class="method-source-code" id="handle_encoding-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 971</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">handle_encoding</span> <span class="ruby-identifier">str</span>
  <span class="ruby-identifier">str</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">dup</span>
  <span class="ruby-identifier">ruby19</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:encoding</span>
  <span class="ruby-identifier">encoding</span> = <span class="ruby-keyword">nil</span>

  <span class="ruby-identifier">header</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">lines</span>.<span class="ruby-identifier">first</span>(<span class="ruby-value">2</span>)
  <span class="ruby-identifier">header</span>.<span class="ruby-identifier">map!</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">force_encoding</span> <span class="ruby-string">&quot;ASCII-8BIT&quot;</span> } <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby19</span>

  <span class="ruby-identifier">first</span> = <span class="ruby-identifier">header</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">encoding</span>, <span class="ruby-identifier">str</span> = <span class="ruby-string">&quot;utf-8&quot;</span>, <span class="ruby-identifier">str</span>[<span class="ruby-value">3</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">first</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\A\xEF\xBB\xBF/</span>

  <span class="ruby-identifier">encoding</span> = <span class="ruby-node">$1</span>.<span class="ruby-identifier">strip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">header</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">s</span>[<span class="ruby-node">/^#.*?-\*-.*?coding:\s*([^ ;]+).*?-\*-/</span>, <span class="ruby-value">1</span>] <span class="ruby-operator">||</span>
    <span class="ruby-identifier">s</span>[<span class="ruby-node">/^#.*(?:en)?coding(?:\s*[:=])\s*([\w-]+)/</span>, <span class="ruby-value">1</span>]
  }

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">encoding</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby19</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">encoding</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp">/utf-8-.+$/</span>, <span class="ruby-string">'utf-8'</span>) <span class="ruby-comment"># HACK for stupid emacs formats</span>
      <span class="ruby-identifier">hack_encoding</span> <span class="ruby-identifier">str</span>, <span class="ruby-identifier">encoding</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">warn</span> <span class="ruby-string">&quot;Skipping magic encoding comment&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-comment"># nothing specified... ugh. try to encode as utf-8</span>
    <span class="ruby-identifier">hack_encoding</span> <span class="ruby-identifier">str</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby19</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">str</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- handle_encoding-source -->
          
        </div>

        

        
      </div><!-- handle_encoding-method -->

    
      <div id="method-i-list_append" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">list_append</span><span
            class="method-args">(list, item)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="list_append-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 456</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">list_append</span> <span class="ruby-identifier">list</span>, <span class="ruby-identifier">item</span> <span class="ruby-comment"># TODO: nuke me *sigh*</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:array</span>, <span class="ruby-identifier">item</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">list</span>
  <span class="ruby-identifier">list</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:array</span>, <span class="ruby-identifier">list</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">Sexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">list</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">list</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:array</span>
  <span class="ruby-identifier">list</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">item</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- list_append-source -->
          
        </div>

        

        
      </div><!-- list_append-method -->

    
      <div id="method-i-list_prepend" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">list_prepend</span><span
            class="method-args">(item, list)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="list_prepend-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 462</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">list_prepend</span> <span class="ruby-identifier">item</span>, <span class="ruby-identifier">list</span> <span class="ruby-comment"># TODO: nuke me *sigh*</span>
  <span class="ruby-identifier">list</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:array</span>, <span class="ruby-identifier">list</span>) <span class="ruby-keyword">unless</span> <span class="ruby-constant">Sexp</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">list</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">list</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span>
  <span class="ruby-identifier">list</span>.<span class="ruby-identifier">insert</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">item</span>
  <span class="ruby-identifier">list</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- list_prepend-source -->
          
        </div>

        

        
      </div><!-- list_prepend-method -->

    
      <div id="method-i-literal_concat" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">literal_concat</span><span
            class="method-args">(head, tail)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="literal_concat-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 468</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">literal_concat</span> <span class="ruby-identifier">head</span>, <span class="ruby-identifier">tail</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">tail</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">head</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">head</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">tail</span>

  <span class="ruby-identifier">htype</span>, <span class="ruby-identifier">ttype</span> = <span class="ruby-identifier">head</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">tail</span>[<span class="ruby-value">0</span>]

  <span class="ruby-identifier">head</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:dstr</span>, <span class="ruby-string">''</span>, <span class="ruby-identifier">head</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">htype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:evstr</span>

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">ttype</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:str</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">htype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:str</span>
      <span class="ruby-identifier">head</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tail</span>[<span class="ruby-value">-1</span>]
    <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">htype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:dstr</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">head</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">head</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tail</span>[<span class="ruby-value">-1</span>]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">head</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tail</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:dstr</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">htype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:str</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">head</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">+</span> <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>]
      <span class="ruby-identifier">head</span> = <span class="ruby-identifier">tail</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">tail</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:array</span>
      <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>] = <span class="ruby-identifier">s</span>(<span class="ruby-value">:str</span>, <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>])
      <span class="ruby-identifier">tail</span>.<span class="ruby-identifier">delete_at</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:str</span>, <span class="ruby-string">''</span>)

      <span class="ruby-identifier">head</span>.<span class="ruby-identifier">push</span>(*<span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:evstr</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">head</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dstr</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">htype</span> <span class="ruby-operator">==</span> <span class="ruby-value">:str</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">head</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">tail</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:str</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">head</span>[<span class="ruby-value">-1</span>] <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">tail</span>[<span class="ruby-value">1</span>][<span class="ruby-value">-1</span>]
      <span class="ruby-identifier">head</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:str</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">head</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-comment"># HACK ?</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">head</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">tail</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">x</span> = [<span class="ruby-identifier">head</span>, <span class="ruby-identifier">tail</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unknown type: #{x.inspect}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">head</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- literal_concat-source -->
          
        </div>

        

        
      </div><!-- literal_concat-method -->

    
      <div id="method-i-logop" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">logop</span><span
            class="method-args">(type, left, right)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="logop-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 512</span>
  <span class="ruby-keyword">def</span> <span class="ruby-identifier">logop</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">left</span>, <span class="ruby-identifier">right</span>) <span class="ruby-comment"># TODO: rename logical_op</span>
    <span class="ruby-identifier">left</span> = <span class="ruby-identifier">value_expr</span> <span class="ruby-identifier">left</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">left</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">left</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">type</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">left</span>.<span class="ruby-identifier">paren</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">node</span>, <span class="ruby-identifier">second</span> = <span class="ruby-identifier">left</span>, <span class="ruby-keyword">nil</span>

      <span class="ruby-keyword">while</span> (<span class="ruby-identifier">second</span> = <span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>]) <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">second</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-identifier">type</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">second</span>.<span class="ruby-identifier">paren</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">node</span> = <span class="ruby-identifier">second</span>
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">s</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">second</span>, <span class="ruby-identifier">right</span>)

      <span class="ruby-keyword">return</span> <span class="ruby-identifier">left</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">left</span>, <span class="ruby-identifier">right</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_aref</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)
    <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>][<span class="ruby-value">0</span>] = <span class="ruby-value">:arglist</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span> <span class="ruby-comment"># REFACTOR</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:self</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">new_call</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">:&quot;[]&quot;</span>, <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">new_call</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>], <span class="ruby-value">:&quot;[]&quot;</span>, <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_body</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">body</span>, <span class="ruby-identifier">resbody</span>, <span class="ruby-identifier">elsebody</span>, <span class="ruby-identifier">ensurebody</span> = <span class="ruby-identifier">val</span>

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">body</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">resbody</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:rescue</span>)
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>

      <span class="ruby-identifier">res</span> = <span class="ruby-identifier">resbody</span>

      <span class="ruby-keyword">while</span> <span class="ruby-identifier">res</span> <span class="ruby-keyword">do</span>
        <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">res</span>
        <span class="ruby-identifier">res</span> = <span class="ruby-identifier">res</span>.<span class="ruby-identifier">resbody</span>(<span class="ruby-keyword">true</span>)
      <span class="ruby-keyword">end</span>

      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">elsebody</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">elsebody</span>

      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = (<span class="ruby-identifier">body</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">resbody</span>).<span class="ruby-identifier">line</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">elsebody</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">resbody</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">warning</span>(<span class="ruby-string">&quot;else without rescue is useless&quot;</span>)
      <span class="ruby-identifier">result</span> = <span class="ruby-identifier">block_append</span>(<span class="ruby-identifier">s</span>(<span class="ruby-value">:begin</span>, <span class="ruby-identifier">result</span>), <span class="ruby-identifier">elsebody</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:ensure</span>, <span class="ruby-identifier">result</span>, <span class="ruby-identifier">ensurebody</span>).<span class="ruby-identifier">compact</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ensurebody</span>

    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">argl</span> <span class="ruby-identifier">x</span>
    <span class="ruby-identifier">x</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">x</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">x</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">x</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">!=</span> <span class="ruby-value">:arglist</span>
    <span class="ruby-identifier">x</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">backref_assign_error</span> <span class="ruby-identifier">ref</span>
    <span class="ruby-comment"># TODO: need a test for this... obviously</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">first</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:nth_ref</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 2&quot;</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;Can't set variable %p&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:back_ref</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 3&quot;</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;Can't set back reference %p&quot;</span> <span class="ruby-operator">%</span> <span class="ruby-identifier">ref</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;Unknown backref type: #{ref.inspect}&quot;</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_call</span> <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">meth</span>, <span class="ruby-identifier">args</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:call</span>, <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">meth</span>)

    <span class="ruby-comment"># TODO: need a test with f(&amp;b) to produce block_pass</span>
    <span class="ruby-comment"># TODO: need a test with f(&amp;b) { } to produce warning</span>

    <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)
    <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:arglist</span> <span class="ruby-keyword">if</span> [<span class="ruby-value">:args</span>, <span class="ruby-value">:array</span>, <span class="ruby-value">:call_args</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span>
    <span class="ruby-identifier">args</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">args</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:arglist</span>

    <span class="ruby-comment"># HACK quick hack to make this work quickly... easy to clean up above</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">args</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]

    <span class="ruby-identifier">line</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-constant">Sexp</span>).<span class="ruby-identifier">map</span>(&amp;<span class="ruby-value">:line</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">line</span>

    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_case</span> <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">body</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:case</span>, <span class="ruby-identifier">expr</span>)
    <span class="ruby-identifier">line</span> = (<span class="ruby-identifier">expr</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">body</span>).<span class="ruby-identifier">line</span>

    <span class="ruby-keyword">while</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:when</span>
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span>
      <span class="ruby-identifier">body</span> = <span class="ruby-identifier">body</span>.<span class="ruby-identifier">delete_at</span> <span class="ruby-value">3</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>[<span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">block</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">block</span>(<span class="ruby-value">:delete</span>)
      <span class="ruby-identifier">node</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">block</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># else</span>
    <span class="ruby-identifier">body</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:block</span>)
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_class</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">line</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">superclass</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">3</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">5</span>]

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:class</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">superclass</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(*<span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_compstmt</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">void_stmts</span>(<span class="ruby-identifier">val</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-constant">Sexp</span>)[<span class="ruby-value">0</span>])
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">result</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_defn</span> <span class="ruby-identifier">val</span>
    (<span class="ruby-identifier">_</span>, <span class="ruby-identifier">line</span>), <span class="ruby-identifier">name</span>, <span class="ruby-identifier">_</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">body</span>, * = <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">body</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:nil</span>)

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:defn</span>, <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">args</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(*<span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_defs</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">4</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">6</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">7</span>]

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:defs</span>, <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">args</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(*<span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">recv</span>.<span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_for</span> <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">var</span>, <span class="ruby-identifier">body</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:for</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">var</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">var</span>.<span class="ruby-identifier">line</span>)
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_if</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">f</span>
    <span class="ruby-identifier">l</span> = [<span class="ruby-identifier">c</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">t</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">f</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">line</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
    <span class="ruby-identifier">c</span> = <span class="ruby-identifier">cond</span> <span class="ruby-identifier">c</span>
    <span class="ruby-identifier">c</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">f</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">last</span>, <span class="ruby-identifier">f</span>, <span class="ruby-identifier">t</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:not</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">canonicalize_conditions</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:if</span>, <span class="ruby-identifier">c</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">f</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">l</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_iter</span> <span class="ruby-identifier">call</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">body</span>
    <span class="ruby-identifier">body</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">nil</span>

    <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:args</span>)
    <span class="ruby-identifier">args</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:args</span>, <span class="ruby-identifier">args</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">Symbol</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">args</span>

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:iter</span>)
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">call</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">call</span>
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">args</span>
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>

    <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:args</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>

    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_masgn</span> <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span>, <span class="ruby-identifier">wrap</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">value_expr</span>(<span class="ruby-identifier">rhs</span>)
    <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">lhs</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:to_ary</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:array</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">wrap</span>

    <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">delete_at</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lhs</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">nil?</span>
    <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rhs</span>

    <span class="ruby-identifier">lhs</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_module</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">line</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">4</span>]

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:module</span>, <span class="ruby-identifier">path</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># REFACTOR?</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(*<span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_op_asgn</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">asgn_op</span>, <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
    <span class="ruby-identifier">name</span> = <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">value</span>
    <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">arg</span>)
    <span class="ruby-identifier">result</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">asgn_op</span> <span class="ruby-comment"># REFACTOR</span>
             <span class="ruby-keyword">when</span> <span class="ruby-value">:&quot;||&quot;</span> <span class="ruby-keyword">then</span>
               <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
               <span class="ruby-identifier">s</span>(<span class="ruby-value">:op_asgn_or</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">name</span>), <span class="ruby-identifier">lhs</span>)
             <span class="ruby-keyword">when</span> <span class="ruby-value">:&quot;&amp;&amp;&quot;</span> <span class="ruby-keyword">then</span>
               <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
               <span class="ruby-identifier">s</span>(<span class="ruby-value">:op_asgn_and</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">name</span>), <span class="ruby-identifier">lhs</span>)
             <span class="ruby-keyword">else</span>
               <span class="ruby-comment"># TODO: why [2] ?</span>
               <span class="ruby-identifier">lhs</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">new_call</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">name</span>), <span class="ruby-identifier">asgn_op</span>, <span class="ruby-identifier">argl</span>(<span class="ruby-identifier">arg</span>))
               <span class="ruby-identifier">lhs</span>
             <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_regexp</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">node</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:str</span>, <span class="ruby-string">''</span>)
    <span class="ruby-identifier">options</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]

    <span class="ruby-identifier">o</span>, <span class="ruby-identifier">k</span> = <span class="ruby-value">0</span>, <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">options</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">//</span>).<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-comment"># FIX: this has a better home</span>
      <span class="ruby-identifier">v</span> = {
        <span class="ruby-string">'x'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">EXTENDED</span>,
        <span class="ruby-string">'i'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">IGNORECASE</span>,
        <span class="ruby-string">'m'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">MULTILINE</span>,
        <span class="ruby-string">'o'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ONCE</span>,
        <span class="ruby-string">'n'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_NONE</span>,
        <span class="ruby-string">'e'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_EUC</span>,
        <span class="ruby-string">'s'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_SJIS</span>,
        <span class="ruby-string">'u'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_UTF8</span>,
      }[<span class="ruby-identifier">c</span>]
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unknown regexp option: #{c}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">v</span>
      <span class="ruby-identifier">o</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">v</span>
      <span class="ruby-identifier">k</span> = <span class="ruby-identifier">c</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/[esu]/</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-value">:str</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:lit</span>
      <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>] = <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">then</span>
                  <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">o</span>, <span class="ruby-identifier">k</span>)
                <span class="ruby-keyword">else</span>
                  <span class="ruby-keyword">begin</span>
                    <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">o</span>)
                  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RegexpError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
                    <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;Ignoring: #{e.message}&quot;</span>
                    <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_NONE</span>)
                  <span class="ruby-keyword">end</span>
                <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:dstr</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/o/</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dregx_once</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dregx</span>
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">node</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:dregx</span>, <span class="ruby-string">''</span>, <span class="ruby-identifier">node</span>);
      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dregx_once</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/o/</span>
      <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_resbody</span> <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">body</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">body</span>.<span class="ruby-identifier">shift</span> <span class="ruby-comment"># remove block and splat it in directly</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">body</span> = [<span class="ruby-identifier">body</span>]
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:resbody</span>, <span class="ruby-identifier">cond</span>, *<span class="ruby-identifier">body</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_sclass</span> <span class="ruby-identifier">val</span>
    <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">in_def</span>, <span class="ruby-identifier">in_single</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">3</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">4</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">6</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">7</span>]

    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:sclass</span>, <span class="ruby-identifier">recv</span>)

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(*<span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_def</span> = <span class="ruby-identifier">in_def</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_single</span> = <span class="ruby-identifier">in_single</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_super</span> <span class="ruby-identifier">args</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">s</span>(<span class="ruby-value">:super</span>, <span class="ruby-identifier">args</span>)
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)
      <span class="ruby-identifier">s</span>(<span class="ruby-value">:super</span>, *<span class="ruby-identifier">args</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_undef</span> <span class="ruby-identifier">n</span>, <span class="ruby-identifier">m</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">block_append</span>(<span class="ruby-identifier">n</span>, <span class="ruby-identifier">s</span>(<span class="ruby-value">:undef</span>, <span class="ruby-identifier">m</span>))
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">s</span>(<span class="ruby-value">:undef</span>, <span class="ruby-identifier">n</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_until</span> <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
    <span class="ruby-identifier">new_until_or_while</span> <span class="ruby-value">:until</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_until_or_while</span> <span class="ruby-identifier">type</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
    <span class="ruby-identifier">other</span> = <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:until</span> <span class="ruby-operator">?</span> <span class="ruby-value">:while</span> <span class="ruby-operator">:</span> <span class="ruby-value">:until</span>
    <span class="ruby-identifier">line</span> = [<span class="ruby-identifier">block</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">block</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">line</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
    <span class="ruby-identifier">block</span>, <span class="ruby-identifier">pre</span> = <span class="ruby-identifier">block</span>.<span class="ruby-identifier">last</span>, <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">block</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:begin</span>

    <span class="ruby-identifier">expr</span> = <span class="ruby-identifier">cond</span> <span class="ruby-identifier">expr</span>

    <span class="ruby-identifier">result</span> = <span class="ruby-keyword">unless</span> <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:not</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">canonicalize_conditions</span> <span class="ruby-keyword">then</span>
               <span class="ruby-identifier">s</span>(<span class="ruby-identifier">type</span>,  <span class="ruby-identifier">expr</span>,      <span class="ruby-identifier">block</span>, <span class="ruby-identifier">pre</span>)
             <span class="ruby-keyword">else</span>
               <span class="ruby-identifier">s</span>(<span class="ruby-identifier">other</span>, <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">last</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">pre</span>)
             <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_when</span> <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">body</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:when</span>, <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">body</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_while</span> <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
    <span class="ruby-identifier">new_until_or_while</span> <span class="ruby-value">:while</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_xstring</span> <span class="ruby-identifier">str</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">str</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">case</span> <span class="ruby-identifier">str</span>[<span class="ruby-value">0</span>]
      <span class="ruby-keyword">when</span> <span class="ruby-value">:str</span>
        <span class="ruby-identifier">str</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:xstr</span>
      <span class="ruby-keyword">when</span> <span class="ruby-value">:dstr</span>
        <span class="ruby-identifier">str</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dxstr</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">str</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:dxstr</span>, <span class="ruby-string">''</span>, <span class="ruby-identifier">str</span>)
      <span class="ruby-keyword">end</span>
      <span class="ruby-identifier">str</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">s</span>(<span class="ruby-value">:xstr</span>, <span class="ruby-string">''</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">new_yield</span> <span class="ruby-identifier">args</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-comment"># TODO: raise args.inspect unless [:arglist].include? args.first # HACK</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 4&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;Block argument should not be given.&quot;</span> <span class="ruby-keyword">if</span>
      <span class="ruby-identifier">args</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>

    <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)

    <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:arglist</span> <span class="ruby-keyword">if</span> [<span class="ruby-value">:call_args</span>, <span class="ruby-value">:array</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>])
    <span class="ruby-identifier">args</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">args</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:arglist</span>

    <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:yield</span>, *<span class="ruby-identifier">args</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">next_token</span>
    <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">advance</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">token</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">yacc_value</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">return</span> [<span class="ruby-keyword">false</span>, <span class="ruby-string">'$end'</span>]
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">node_assign</span>(<span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-comment"># TODO: rename new_assign</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">lhs</span>

    <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">value_expr</span> <span class="ruby-identifier">rhs</span>

    <span class="ruby-keyword">case</span> <span class="ruby-identifier">lhs</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-value">:gasgn</span>, <span class="ruby-value">:iasgn</span>, <span class="ruby-value">:lasgn</span>, <span class="ruby-value">:masgn</span>, <span class="ruby-value">:cdecl</span>, <span class="ruby-value">:cvdecl</span>, <span class="ruby-value">:cvasgn</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rhs</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:attrasgn</span>, <span class="ruby-value">:call</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">args</span> = <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">pop</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">Symbol</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">last</span>
      <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">arg_add</span>(<span class="ruby-identifier">args</span>, <span class="ruby-identifier">rhs</span>)[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-value">:const</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">lhs</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:cdecl</span>
      <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rhs</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unknown lhs #{lhs.inspect}&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">lhs</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">##</span>
  <span class="ruby-comment"># Returns a UTF-8 encoded string after processing BOMs and magic</span>
  <span class="ruby-comment"># encoding comments.</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># Holy crap... ok. Here goes:</span>
  <span class="ruby-comment">#</span>
  <span class="ruby-comment"># Ruby's file handling and encoding support is insane. We need to be</span>
  <span class="ruby-comment"># able to lex a file. The lexer file is explicitly UTF-8 to make</span>
  <span class="ruby-comment"># things cleaner. This allows us to deal with extended chars in</span>
  <span class="ruby-comment"># class and method names. In order to do this, we need to encode all</span>
  <span class="ruby-comment"># input source files as UTF-8. First, we look for a UTF-8 BOM by</span>
  <span class="ruby-comment"># looking at the first line while forcing its encoding to</span>
  <span class="ruby-comment"># ASCII-8BIT. If we find a BOM, we strip it and set the expected</span>
  <span class="ruby-comment"># encoding to UTF-8. Then, we search for a magic encoding comment.</span>
  <span class="ruby-comment"># If found, it overrides the BOM. Finally, we force the encoding of</span>
  <span class="ruby-comment"># the input string to whatever was found, and then encode that to</span>
  <span class="ruby-comment"># UTF-8 for compatibility with the lexer.</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">handle_encoding</span> <span class="ruby-identifier">str</span>
    <span class="ruby-identifier">str</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">dup</span>
    <span class="ruby-identifier">ruby19</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">respond_to?</span> <span class="ruby-value">:encoding</span>
    <span class="ruby-identifier">encoding</span> = <span class="ruby-keyword">nil</span>

    <span class="ruby-identifier">header</span> = <span class="ruby-identifier">str</span>.<span class="ruby-identifier">lines</span>.<span class="ruby-identifier">first</span>(<span class="ruby-value">2</span>)
    <span class="ruby-identifier">header</span>.<span class="ruby-identifier">map!</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span> <span class="ruby-identifier">s</span>.<span class="ruby-identifier">force_encoding</span> <span class="ruby-string">&quot;ASCII-8BIT&quot;</span> } <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby19</span>

    <span class="ruby-identifier">first</span> = <span class="ruby-identifier">header</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">||</span> <span class="ruby-string">&quot;&quot;</span>
    <span class="ruby-identifier">encoding</span>, <span class="ruby-identifier">str</span> = <span class="ruby-string">&quot;utf-8&quot;</span>, <span class="ruby-identifier">str</span>[<span class="ruby-value">3</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">first</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/\A\xEF\xBB\xBF/</span>

    <span class="ruby-identifier">encoding</span> = <span class="ruby-node">$1</span>.<span class="ruby-identifier">strip</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">header</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">s</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">s</span>[<span class="ruby-node">/^#.*?-\*-.*?coding:\s*([^ ;]+).*?-\*-/</span>, <span class="ruby-value">1</span>] <span class="ruby-operator">||</span>
      <span class="ruby-identifier">s</span>[<span class="ruby-node">/^#.*(?:en)?coding(?:\s*[:=])\s*([\w-]+)/</span>, <span class="ruby-value">1</span>]
    }

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">encoding</span> <span class="ruby-keyword">then</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby19</span> <span class="ruby-keyword">then</span>
        <span class="ruby-identifier">encoding</span>.<span class="ruby-identifier">sub!</span>(<span class="ruby-regexp">/utf-8-.+$/</span>, <span class="ruby-string">'utf-8'</span>) <span class="ruby-comment"># HACK for stupid emacs formats</span>
        <span class="ruby-identifier">hack_encoding</span> <span class="ruby-identifier">str</span>, <span class="ruby-identifier">encoding</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">warn</span> <span class="ruby-string">&quot;Skipping magic encoding comment&quot;</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-comment"># nothing specified... ugh. try to encode as utf-8</span>
      <span class="ruby-identifier">hack_encoding</span> <span class="ruby-identifier">str</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ruby19</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">str</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">hack_encoding</span> <span class="ruby-identifier">str</span>, <span class="ruby-identifier">extra</span> = <span class="ruby-keyword">nil</span>
    <span class="ruby-identifier">encodings</span> = <span class="ruby-constant">ENCODING_ORDER</span>.<span class="ruby-identifier">dup</span>
    <span class="ruby-identifier">encodings</span>.<span class="ruby-identifier">unshift</span>(<span class="ruby-identifier">extra</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">extra</span>.<span class="ruby-identifier">nil?</span>

    <span class="ruby-comment"># terrible, horrible, no good, very bad, last ditch effort.</span>
    <span class="ruby-identifier">encodings</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">enc</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">begin</span>
        <span class="ruby-identifier">str</span>.<span class="ruby-identifier">force_encoding</span> <span class="ruby-identifier">enc</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">valid_encoding?</span> <span class="ruby-keyword">then</span>
          <span class="ruby-identifier">str</span>.<span class="ruby-identifier">encode!</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">UTF_8</span>
          <span class="ruby-keyword">break</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">InvalidByteSequenceError</span>
        <span class="ruby-comment"># do nothing</span>
      <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">UndefinedConversionError</span>
        <span class="ruby-comment"># do nothing</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment"># no amount of pain is enough for you.</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;Bad encoding. Need a magic encoding comment.&quot;</span> <span class="ruby-keyword">unless</span>
      <span class="ruby-identifier">str</span>.<span class="ruby-identifier">encoding</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-string">&quot;UTF-8&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment">##</span>
  <span class="ruby-comment"># Parse +str+ at path +file+ and return a sexp. Raises</span>
  <span class="ruby-comment"># Timeout::Error if it runs for more than +time+ seconds.</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">process</span>(<span class="ruby-identifier">str</span>, <span class="ruby-identifier">file</span> = <span class="ruby-string">&quot;(string)&quot;</span>, <span class="ruby-identifier">time</span> = <span class="ruby-value">10</span>)
    <span class="ruby-constant">Timeout</span>.<span class="ruby-identifier">timeout</span> <span class="ruby-identifier">time</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;bad val: #{str.inspect}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">str</span>

      <span class="ruby-identifier">str</span> = <span class="ruby-identifier">handle_encoding</span> <span class="ruby-identifier">str</span>

      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">file</span> = <span class="ruby-identifier">file</span>.<span class="ruby-identifier">dup</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">src</span> = <span class="ruby-identifier">str</span>

      <span class="ruby-ivar">@yydebug</span> = <span class="ruby-constant">ENV</span>.<span class="ruby-identifier">has_key?</span> <span class="ruby-string">'DEBUG'</span>

      <span class="ruby-identifier">do_parse</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">alias</span> <span class="ruby-value">:parse</span> <span class="ruby-operator">:</span><span class="ruby-identifier">process</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">remove_begin</span> <span class="ruby-identifier">node</span>
    <span class="ruby-identifier">oldnode</span> = <span class="ruby-identifier">node</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">and</span> <span class="ruby-value">:begin</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-keyword">and</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">node</span> = <span class="ruby-identifier">node</span>[<span class="ruby-value">-1</span>]
      <span class="ruby-identifier">node</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">oldnode</span>.<span class="ruby-identifier">line</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">reset</span>
    <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">reset</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_def</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_single</span> = <span class="ruby-value">0</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">reset</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">clear</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">block_dup_check</span> <span class="ruby-identifier">call_or_args</span>, <span class="ruby-identifier">block</span>
    <span class="ruby-identifier">syntax_error</span> <span class="ruby-string">&quot;Both block arg and actual block given.&quot;</span> <span class="ruby-keyword">if</span>
      <span class="ruby-identifier">block</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">call_or_args</span>.<span class="ruby-identifier">block_pass?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">ret_args</span> <span class="ruby-identifier">node</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 5&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>

      <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;block argument should not be given&quot;</span> <span class="ruby-keyword">if</span>
        <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>

      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:array</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:call_args</span>
      <span class="ruby-identifier">node</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">last</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>

      <span class="ruby-comment"># HACK matz wraps ONE of the FOUR splats in a newline to</span>
      <span class="ruby-comment"># distinguish. I use paren for now. ugh</span>
      <span class="ruby-identifier">node</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:svalue</span>, <span class="ruby-identifier">node</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:splat</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">paren</span>
      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:svalue</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:arglist</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:splat</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">s</span>(*<span class="ruby-identifier">args</span>)
    <span class="ruby-identifier">result</span> = <span class="ruby-constant">Sexp</span>.<span class="ruby-identifier">new</span>(*<span class="ruby-identifier">args</span>)
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">lineno</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">src</span>          <span class="ruby-comment"># otherwise...</span>
    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">file</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">file</span>
    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">value_expr</span> <span class="ruby-identifier">oldnode</span> <span class="ruby-comment"># HACK</span>
    <span class="ruby-identifier">node</span> = <span class="ruby-identifier">remove_begin</span> <span class="ruby-identifier">oldnode</span>
    <span class="ruby-identifier">node</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">oldnode</span>.<span class="ruby-identifier">line</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">oldnode</span>
    <span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">value_expr</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:if</span>
    <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">void_stmts</span> <span class="ruby-identifier">node</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node</span>
    <span class="ruby-keyword">return</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:block</span>

    <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] = <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">n</span>) }
    <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">warning</span> <span class="ruby-identifier">s</span>
    <span class="ruby-comment"># do nothing for now</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">alias</span> <span class="ruby-identifier">yyerror</span> <span class="ruby-identifier">syntax_error</span>

  <span class="ruby-keyword">def</span> <span class="ruby-identifier">on_error</span>(<span class="ruby-identifier">et</span>, <span class="ruby-identifier">ev</span>, <span class="ruby-identifier">values</span>)
    <span class="ruby-keyword">super</span>
  <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Racc</span><span class="ruby-operator">::</span><span class="ruby-constant">ParseError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
    <span class="ruby-comment"># I don't like how the exception obscures the error message</span>
    <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>.<span class="ruby-identifier">replace</span> <span class="ruby-string">&quot;%s:%p :: %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-keyword">self</span>.<span class="ruby-identifier">file</span>, <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">lineno</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>.<span class="ruby-identifier">strip</span>]
    <span class="ruby-identifier">warn</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">$DEBUG</span>
    <span class="ruby-identifier">raise</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">class</span> <span class="ruby-constant">Keyword</span>
    <span class="ruby-keyword">class</span> <span class="ruby-constant">KWtable</span>
      <span class="ruby-identifier">attr_accessor</span> <span class="ruby-value">:name</span>, <span class="ruby-value">:state</span>, <span class="ruby-value">:id0</span>, <span class="ruby-value">:id1</span>
      <span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">id</span>=[], <span class="ruby-identifier">state</span>=<span class="ruby-keyword">nil</span>)
        <span class="ruby-ivar">@name</span>  = <span class="ruby-identifier">name</span>
        <span class="ruby-ivar">@id0</span>, <span class="ruby-ivar">@id1</span> = <span class="ruby-identifier">id</span>
        <span class="ruby-ivar">@state</span> = <span class="ruby-identifier">state</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-comment">##</span>
    <span class="ruby-comment"># :stopdoc:</span>
    <span class="ruby-comment">#</span>
    <span class="ruby-comment"># :expr_beg    = ignore newline, +/- is a sign.</span>
    <span class="ruby-comment"># :expr_end    = newline significant, +/- is a operator.</span>
    <span class="ruby-comment"># :expr_arg    = newline significant, +/- is a operator.</span>
    <span class="ruby-comment"># :expr_cmdarg = newline significant, +/- is a operator.</span>
    <span class="ruby-comment"># :expr_endarg = newline significant, +/- is a operator.</span>
    <span class="ruby-comment"># :expr_mid    = newline significant, +/- is a operator.</span>
    <span class="ruby-comment"># :expr_fname  = ignore newline, no reserved words.</span>
    <span class="ruby-comment"># :expr_dot    = right after . or ::, no reserved words.</span>
    <span class="ruby-comment"># :expr_class  = immediate after class, no here document.</span>

    <span class="ruby-identifier">wordlist</span> = [
                [<span class="ruby-string">&quot;end&quot;</span>,      [<span class="ruby-value">:kEND</span>,      <span class="ruby-value">:kEND</span>        ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;else&quot;</span>,     [<span class="ruby-value">:kELSE</span>,     <span class="ruby-value">:kELSE</span>       ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;case&quot;</span>,     [<span class="ruby-value">:kCASE</span>,     <span class="ruby-value">:kCASE</span>       ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;ensure&quot;</span>,   [<span class="ruby-value">:kENSURE</span>,   <span class="ruby-value">:kENSURE</span>     ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;module&quot;</span>,   [<span class="ruby-value">:kMODULE</span>,   <span class="ruby-value">:kMODULE</span>     ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;elsif&quot;</span>,    [<span class="ruby-value">:kELSIF</span>,    <span class="ruby-value">:kELSIF</span>      ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;def&quot;</span>,      [<span class="ruby-value">:kDEF</span>,      <span class="ruby-value">:kDEF</span>        ], <span class="ruby-value">:expr_fname</span> ],
                [<span class="ruby-string">&quot;rescue&quot;</span>,   [<span class="ruby-value">:kRESCUE</span>,   <span class="ruby-value">:kRESCUE_MOD</span> ], <span class="ruby-value">:expr_mid</span>   ],
                [<span class="ruby-string">&quot;not&quot;</span>,      [<span class="ruby-value">:kNOT</span>,      <span class="ruby-value">:kNOT</span>        ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;then&quot;</span>,     [<span class="ruby-value">:kTHEN</span>,     <span class="ruby-value">:kTHEN</span>       ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;yield&quot;</span>,    [<span class="ruby-value">:kYIELD</span>,    <span class="ruby-value">:kYIELD</span>      ], <span class="ruby-value">:expr_arg</span>   ],
                [<span class="ruby-string">&quot;for&quot;</span>,      [<span class="ruby-value">:kFOR</span>,      <span class="ruby-value">:kFOR</span>        ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;self&quot;</span>,     [<span class="ruby-value">:kSELF</span>,     <span class="ruby-value">:kSELF</span>       ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;false&quot;</span>,    [<span class="ruby-value">:kFALSE</span>,    <span class="ruby-value">:kFALSE</span>      ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;retry&quot;</span>,    [<span class="ruby-value">:kRETRY</span>,    <span class="ruby-value">:kRETRY</span>      ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;return&quot;</span>,   [<span class="ruby-value">:kRETURN</span>,   <span class="ruby-value">:kRETURN</span>     ], <span class="ruby-value">:expr_mid</span>   ],
                [<span class="ruby-string">&quot;true&quot;</span>,     [<span class="ruby-value">:kTRUE</span>,     <span class="ruby-value">:kTRUE</span>       ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;if&quot;</span>,       [<span class="ruby-value">:kIF</span>,       <span class="ruby-value">:kIF_MOD</span>     ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;defined?&quot;</span>, [<span class="ruby-value">:kDEFINED</span>,  <span class="ruby-value">:kDEFINED</span>    ], <span class="ruby-value">:expr_arg</span>   ],
                [<span class="ruby-string">&quot;super&quot;</span>,    [<span class="ruby-value">:kSUPER</span>,    <span class="ruby-value">:kSUPER</span>      ], <span class="ruby-value">:expr_arg</span>   ],
                [<span class="ruby-string">&quot;undef&quot;</span>,    [<span class="ruby-value">:kUNDEF</span>,    <span class="ruby-value">:kUNDEF</span>      ], <span class="ruby-value">:expr_fname</span> ],
                [<span class="ruby-string">&quot;break&quot;</span>,    [<span class="ruby-value">:kBREAK</span>,    <span class="ruby-value">:kBREAK</span>      ], <span class="ruby-value">:expr_mid</span>   ],
                [<span class="ruby-string">&quot;in&quot;</span>,       [<span class="ruby-value">:kIN</span>,       <span class="ruby-value">:kIN</span>         ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;do&quot;</span>,       [<span class="ruby-value">:kDO</span>,       <span class="ruby-value">:kDO</span>         ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;nil&quot;</span>,      [<span class="ruby-value">:kNIL</span>,      <span class="ruby-value">:kNIL</span>        ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;until&quot;</span>,    [<span class="ruby-value">:kUNTIL</span>,    <span class="ruby-value">:kUNTIL_MOD</span>  ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;unless&quot;</span>,   [<span class="ruby-value">:kUNLESS</span>,   <span class="ruby-value">:kUNLESS_MOD</span> ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;or&quot;</span>,       [<span class="ruby-value">:kOR</span>,       <span class="ruby-value">:kOR</span>         ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;next&quot;</span>,     [<span class="ruby-value">:kNEXT</span>,     <span class="ruby-value">:kNEXT</span>       ], <span class="ruby-value">:expr_mid</span>   ],
                [<span class="ruby-string">&quot;when&quot;</span>,     [<span class="ruby-value">:kWHEN</span>,     <span class="ruby-value">:kWHEN</span>       ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;redo&quot;</span>,     [<span class="ruby-value">:kREDO</span>,     <span class="ruby-value">:kREDO</span>       ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;and&quot;</span>,      [<span class="ruby-value">:kAND</span>,      <span class="ruby-value">:kAND</span>        ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;begin&quot;</span>,    [<span class="ruby-value">:kBEGIN</span>,    <span class="ruby-value">:kBEGIN</span>      ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;__LINE__&quot;</span>, [<span class="ruby-value">:k__LINE__</span>, <span class="ruby-value">:k__LINE__</span>   ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;class&quot;</span>,    [<span class="ruby-value">:kCLASS</span>,    <span class="ruby-value">:kCLASS</span>      ], <span class="ruby-value">:expr_class</span> ],
                [<span class="ruby-string">&quot;__FILE__&quot;</span>, [<span class="ruby-value">:k__FILE__</span>, <span class="ruby-value">:k__FILE__</span>   ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;END&quot;</span>,      [<span class="ruby-value">:klEND</span>,     <span class="ruby-value">:klEND</span>       ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;BEGIN&quot;</span>,    [<span class="ruby-value">:klBEGIN</span>,   <span class="ruby-value">:klBEGIN</span>     ], <span class="ruby-value">:expr_end</span>   ],
                [<span class="ruby-string">&quot;while&quot;</span>,    [<span class="ruby-value">:kWHILE</span>,    <span class="ruby-value">:kWHILE_MOD</span>  ], <span class="ruby-value">:expr_beg</span>   ],
                [<span class="ruby-string">&quot;alias&quot;</span>,    [<span class="ruby-value">:kALIAS</span>,    <span class="ruby-value">:kALIAS</span>      ], <span class="ruby-value">:expr_fname</span> ],
                [<span class="ruby-string">&quot;__ENCODING__&quot;</span>, [<span class="ruby-value">:k__ENCODING__</span>, <span class="ruby-value">:k__ENCODING__</span>], <span class="ruby-value">:expr_end</span>],
               ].<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">args</span><span class="ruby-operator">|</span> <span class="ruby-constant">KWtable</span>.<span class="ruby-identifier">new</span>(*<span class="ruby-identifier">args</span>) }

    <span class="ruby-comment"># :startdoc:</span>

    <span class="ruby-constant">WORDLIST18</span> = <span class="ruby-constant">Hash</span>[*<span class="ruby-identifier">wordlist</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">o</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">o</span>] }.<span class="ruby-identifier">flatten</span>]
    <span class="ruby-constant">WORDLIST19</span> = <span class="ruby-constant">Hash</span>[*<span class="ruby-identifier">wordlist</span>.<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">o</span><span class="ruby-operator">|</span> [<span class="ruby-identifier">o</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">o</span>] }.<span class="ruby-identifier">flatten</span>]

    <span class="ruby-constant">WORDLIST18</span>.<span class="ruby-identifier">delete</span> <span class="ruby-string">&quot;__ENCODING__&quot;</span>

    <span class="ruby-node">%w[and case elsif for if in module or unless until when while]</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span>
      <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">dup</span>
      <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">state</span> = <span class="ruby-value">:expr_value</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-node">%w[not]</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">k</span><span class="ruby-operator">|</span>
      <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">dup</span>
      <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">k</span>].<span class="ruby-identifier">state</span> = <span class="ruby-value">:expr_arg</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">keyword18</span> <span class="ruby-identifier">str</span> <span class="ruby-comment"># REFACTOR</span>
      <span class="ruby-constant">WORDLIST18</span>[<span class="ruby-identifier">str</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">keyword19</span> <span class="ruby-identifier">str</span>
      <span class="ruby-constant">WORDLIST19</span>[<span class="ruby-identifier">str</span>]
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">class</span> <span class="ruby-constant">Environment</span>
    <span class="ruby-identifier">attr_reader</span> <span class="ruby-value">:env</span>, <span class="ruby-value">:dyn</span>

    <span class="ruby-keyword">def</span> <span class="ruby-operator">[]</span> <span class="ruby-identifier">k</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">all</span>[<span class="ruby-identifier">k</span>]
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-operator">[]=</span> <span class="ruby-identifier">k</span>, <span class="ruby-identifier">v</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;no&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">v</span> <span class="ruby-operator">==</span> <span class="ruby-keyword">true</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">current</span>[<span class="ruby-identifier">k</span>] = <span class="ruby-identifier">v</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">all</span>
      <span class="ruby-identifier">idx</span> = <span class="ruby-ivar">@dyn</span>.<span class="ruby-identifier">index</span>(<span class="ruby-keyword">false</span>) <span class="ruby-operator">||</span> <span class="ruby-value">0</span>
      <span class="ruby-ivar">@env</span>[<span class="ruby-value">0</span><span class="ruby-operator">..</span><span class="ruby-identifier">idx</span>].<span class="ruby-identifier">reverse</span>.<span class="ruby-identifier">inject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">env</span>, <span class="ruby-identifier">scope</span><span class="ruby-operator">|</span> <span class="ruby-identifier">env</span>.<span class="ruby-identifier">merge</span> <span class="ruby-identifier">scope</span> }
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">current</span>
      <span class="ruby-ivar">@env</span>.<span class="ruby-identifier">first</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">dynamic</span>
      <span class="ruby-identifier">idx</span> = <span class="ruby-ivar">@dyn</span>.<span class="ruby-identifier">index</span> <span class="ruby-keyword">false</span>
      <span class="ruby-ivar">@env</span>[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">idx</span>].<span class="ruby-identifier">reverse</span>.<span class="ruby-identifier">inject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">env</span>, <span class="ruby-identifier">scope</span><span class="ruby-operator">|</span> <span class="ruby-identifier">env</span>.<span class="ruby-identifier">merge</span> <span class="ruby-identifier">scope</span> } <span class="ruby-operator">||</span> {}
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">dynamic?</span>
      <span class="ruby-ivar">@dyn</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">!=</span> <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">extend</span> <span class="ruby-identifier">dyn</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-ivar">@dyn</span>.<span class="ruby-identifier">unshift</span> <span class="ruby-identifier">dyn</span>
      <span class="ruby-ivar">@env</span>.<span class="ruby-identifier">unshift</span>({})
      <span class="ruby-ivar">@use</span>.<span class="ruby-identifier">unshift</span>({})
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span> <span class="ruby-identifier">dyn</span> = <span class="ruby-keyword">false</span>
      <span class="ruby-ivar">@dyn</span> = []
      <span class="ruby-ivar">@env</span> = []
      <span class="ruby-ivar">@use</span> = []
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">reset</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">reset</span>
      <span class="ruby-ivar">@dyn</span>.<span class="ruby-identifier">clear</span>
      <span class="ruby-ivar">@env</span>.<span class="ruby-identifier">clear</span>
      <span class="ruby-ivar">@use</span>.<span class="ruby-identifier">clear</span>
      <span class="ruby-keyword">self</span>.<span class="ruby-identifier">extend</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">unextend</span>
      <span class="ruby-ivar">@dyn</span>.<span class="ruby-identifier">shift</span>
      <span class="ruby-ivar">@env</span>.<span class="ruby-identifier">shift</span>
      <span class="ruby-ivar">@use</span>.<span class="ruby-identifier">shift</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;You went too far unextending env&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@env</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">use</span> <span class="ruby-identifier">id</span>
      <span class="ruby-ivar">@env</span>.<span class="ruby-identifier">each_with_index</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">env</span>, <span class="ruby-identifier">i</span><span class="ruby-operator">|</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">env</span>[<span class="ruby-identifier">id</span>] <span class="ruby-keyword">then</span>
          <span class="ruby-ivar">@use</span>[<span class="ruby-identifier">i</span>][<span class="ruby-identifier">id</span>] = <span class="ruby-keyword">true</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">used?</span> <span class="ruby-identifier">id</span>
      <span class="ruby-identifier">idx</span> = <span class="ruby-ivar">@dyn</span>.<span class="ruby-identifier">index</span> <span class="ruby-keyword">false</span> <span class="ruby-comment"># REFACTOR</span>
      <span class="ruby-identifier">u</span> = <span class="ruby-ivar">@use</span>[<span class="ruby-value">0</span><span class="ruby-operator">...</span><span class="ruby-identifier">idx</span>].<span class="ruby-identifier">reverse</span>.<span class="ruby-identifier">inject</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">env</span>, <span class="ruby-identifier">scope</span><span class="ruby-operator">|</span> <span class="ruby-identifier">env</span>.<span class="ruby-identifier">merge</span> <span class="ruby-identifier">scope</span> } <span class="ruby-operator">||</span> {}
      <span class="ruby-identifier">u</span>[<span class="ruby-identifier">id</span>]
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">class</span> <span class="ruby-constant">StackState</span>
    <span class="ruby-identifier">attr_reader</span> <span class="ruby-value">:name</span>
    <span class="ruby-identifier">attr_reader</span> <span class="ruby-value">:stack</span>
    <span class="ruby-identifier">attr_accessor</span> <span class="ruby-value">:debug</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">name</span>)
      <span class="ruby-ivar">@name</span> = <span class="ruby-identifier">name</span>
      <span class="ruby-ivar">@stack</span> = [<span class="ruby-keyword">false</span>]
      <span class="ruby-ivar">@debug</span> = <span class="ruby-keyword">false</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">inspect</span>
      <span class="ruby-node">&quot;StackState(#{@name}, #{@stack.inspect})&quot;</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">is_in_state</span>
      <span class="ruby-identifier">p</span> <span class="ruby-value">:stack_is_in_state</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">name</span>, <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">last</span>, <span class="ruby-identifier">caller</span>.<span class="ruby-identifier">first</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
      <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">lexpop</span>
      <span class="ruby-identifier">p</span> <span class="ruby-value">:stack_lexpop</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">caller</span>.<span class="ruby-identifier">first</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
      <span class="ruby-identifier">a</span> = <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">pop</span>
      <span class="ruby-identifier">b</span> = <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">pop</span>
      <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">push</span>(<span class="ruby-identifier">a</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">b</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">pop</span>
      <span class="ruby-identifier">r</span> = <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">pop</span>
      <span class="ruby-identifier">p</span> <span class="ruby-value">:stack_pop</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">name</span>, <span class="ruby-identifier">r</span>, <span class="ruby-ivar">@stack</span>, <span class="ruby-identifier">caller</span>.<span class="ruby-identifier">first</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
      <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">push</span> <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>
      <span class="ruby-identifier">r</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-keyword">def</span> <span class="ruby-identifier">push</span> <span class="ruby-identifier">val</span>
      <span class="ruby-ivar">@stack</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">val</span>
      <span class="ruby-identifier">p</span> <span class="ruby-value">:stack_push</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">name</span>, <span class="ruby-ivar">@stack</span>, <span class="ruby-identifier">caller</span>.<span class="ruby-identifier">first</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">debug</span>
      <span class="ruby-keyword">nil</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- logop-source -->
          
        </div>

        

        
      </div><!-- logop-method -->

    
      <div id="method-i-new_aref" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_aref</span><span
            class="method-args">(val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_aref-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 530</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_aref</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)
  <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>][<span class="ruby-value">0</span>] = <span class="ruby-value">:arglist</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span> <span class="ruby-comment"># REFACTOR</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>].<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:self</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">new_call</span> <span class="ruby-keyword">nil</span>, <span class="ruby-value">:&quot;[]&quot;</span>, <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">new_call</span> <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>], <span class="ruby-value">:&quot;[]&quot;</span>, <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_aref-source -->
          
        </div>

        

        
      </div><!-- new_aref-method -->

    
      <div id="method-i-new_body" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_body</span><span
            class="method-args">(val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_body-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 541</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_body</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">body</span>, <span class="ruby-identifier">resbody</span>, <span class="ruby-identifier">elsebody</span>, <span class="ruby-identifier">ensurebody</span> = <span class="ruby-identifier">val</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">body</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">resbody</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:rescue</span>)
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>

    <span class="ruby-identifier">res</span> = <span class="ruby-identifier">resbody</span>

    <span class="ruby-keyword">while</span> <span class="ruby-identifier">res</span> <span class="ruby-keyword">do</span>
      <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">res</span>
      <span class="ruby-identifier">res</span> = <span class="ruby-identifier">res</span>.<span class="ruby-identifier">resbody</span>(<span class="ruby-keyword">true</span>)
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">elsebody</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">elsebody</span>

    <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = (<span class="ruby-identifier">body</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">resbody</span>).<span class="ruby-identifier">line</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">elsebody</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">resbody</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">warning</span>(<span class="ruby-string">&quot;else without rescue is useless&quot;</span>)
    <span class="ruby-identifier">result</span> = <span class="ruby-identifier">block_append</span>(<span class="ruby-identifier">s</span>(<span class="ruby-value">:begin</span>, <span class="ruby-identifier">result</span>), <span class="ruby-identifier">elsebody</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:ensure</span>, <span class="ruby-identifier">result</span>, <span class="ruby-identifier">ensurebody</span>).<span class="ruby-identifier">compact</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">ensurebody</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_body-source -->
          
        </div>

        

        
      </div><!-- new_body-method -->

    
      <div id="method-i-new_call" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_call</span><span
            class="method-args">(recv, meth, args = nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_call-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 591</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_call</span> <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">meth</span>, <span class="ruby-identifier">args</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:call</span>, <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">meth</span>)

  <span class="ruby-comment"># TODO: need a test with f(&amp;b) to produce block_pass</span>
  <span class="ruby-comment"># TODO: need a test with f(&amp;b) { } to produce warning</span>

  <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)
  <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:arglist</span> <span class="ruby-keyword">if</span> [<span class="ruby-value">:args</span>, <span class="ruby-value">:array</span>, <span class="ruby-value">:call_args</span>].<span class="ruby-identifier">include?</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span>
  <span class="ruby-identifier">args</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">args</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:arglist</span>

  <span class="ruby-comment"># HACK quick hack to make this work quickly... easy to clean up above</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">args</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]

  <span class="ruby-identifier">line</span> = <span class="ruby-identifier">result</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-constant">Sexp</span>).<span class="ruby-identifier">map</span>(&amp;<span class="ruby-value">:line</span>).<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">line</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_call-source -->
          
        </div>

        

        
      </div><!-- new_call-method -->

    
      <div id="method-i-new_case" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_case</span><span
            class="method-args">(expr, body)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_case-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 610</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_case</span> <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">body</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:case</span>, <span class="ruby-identifier">expr</span>)
  <span class="ruby-identifier">line</span> = (<span class="ruby-identifier">expr</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">body</span>).<span class="ruby-identifier">line</span>

  <span class="ruby-keyword">while</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:when</span>
    <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span>
    <span class="ruby-identifier">body</span> = <span class="ruby-identifier">body</span>.<span class="ruby-identifier">delete_at</span> <span class="ruby-value">3</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>[<span class="ruby-value">2</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">node</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">block</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">block</span>(<span class="ruby-value">:delete</span>)
    <span class="ruby-identifier">node</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">block</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-comment"># else</span>
  <span class="ruby-identifier">body</span> = <span class="ruby-keyword">nil</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:block</span>)
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_case-source -->
          
        </div>

        

        
      </div><!-- new_case-method -->

    
      <div id="method-i-new_class" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_class</span><span
            class="method-args">(val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_class-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 632</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_class</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">line</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">superclass</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">3</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">5</span>]

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:class</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">superclass</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(*<span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_class-source -->
          
        </div>

        

        
      </div><!-- new_class-method -->

    
      <div id="method-i-new_compstmt" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_compstmt</span><span
            class="method-args">(val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_compstmt-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 650</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_compstmt</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">void_stmts</span>(<span class="ruby-identifier">val</span>.<span class="ruby-identifier">grep</span>(<span class="ruby-constant">Sexp</span>)[<span class="ruby-value">0</span>])
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">result</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">result</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_compstmt-source -->
          
        </div>

        

        
      </div><!-- new_compstmt-method -->

    
      <div id="method-i-new_defn" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_defn</span><span
            class="method-args">(val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_defn-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 656</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_defn</span> <span class="ruby-identifier">val</span>
  (<span class="ruby-identifier">_</span>, <span class="ruby-identifier">line</span>), <span class="ruby-identifier">name</span>, <span class="ruby-identifier">_</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">body</span>, * = <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">body</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:nil</span>)

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:defn</span>, <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">args</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(*<span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_defn-source -->
          
        </div>

        

        
      </div><!-- new_defn-method -->

    
      <div id="method-i-new_defs" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_defs</span><span
            class="method-args">(val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_defs-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 675</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_defs</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">name</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">4</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">6</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">7</span>]

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:defs</span>, <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">name</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">args</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(*<span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">recv</span>.<span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_defs-source -->
          
        </div>

        

        
      </div><!-- new_defs-method -->

    
      <div id="method-i-new_for" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_for</span><span
            class="method-args">(expr, var, body)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_for-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 693</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_for</span> <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">var</span>, <span class="ruby-identifier">body</span>
  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:for</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">var</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">var</span>.<span class="ruby-identifier">line</span>)
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_for-source -->
          
        </div>

        

        
      </div><!-- new_for-method -->

    
      <div id="method-i-new_if" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_if</span><span
            class="method-args">(c, t, f)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_if-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 699</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_if</span> <span class="ruby-identifier">c</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">f</span>
  <span class="ruby-identifier">l</span> = [<span class="ruby-identifier">c</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">t</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">t</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">f</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">f</span>.<span class="ruby-identifier">line</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
  <span class="ruby-identifier">c</span> = <span class="ruby-identifier">cond</span> <span class="ruby-identifier">c</span>
  <span class="ruby-identifier">c</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">f</span> = <span class="ruby-identifier">c</span>.<span class="ruby-identifier">last</span>, <span class="ruby-identifier">f</span>, <span class="ruby-identifier">t</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:not</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">canonicalize_conditions</span>
  <span class="ruby-identifier">s</span>(<span class="ruby-value">:if</span>, <span class="ruby-identifier">c</span>, <span class="ruby-identifier">t</span>, <span class="ruby-identifier">f</span>).<span class="ruby-identifier">line</span>(<span class="ruby-identifier">l</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_if-source -->
          
        </div>

        

        
      </div><!-- new_if-method -->

    
      <div id="method-i-new_iter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_iter</span><span
            class="method-args">(call, args, body)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_iter-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 706</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_iter</span> <span class="ruby-identifier">call</span>, <span class="ruby-identifier">args</span>, <span class="ruby-identifier">body</span>
  <span class="ruby-identifier">body</span> <span class="ruby-operator">||=</span> <span class="ruby-keyword">nil</span>

  <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:args</span>)
  <span class="ruby-identifier">args</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:args</span>, <span class="ruby-identifier">args</span>) <span class="ruby-keyword">if</span> <span class="ruby-constant">Symbol</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">args</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:iter</span>)
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">call</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">call</span>
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">args</span>
  <span class="ruby-identifier">result</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>

  <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:args</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">==</span> <span class="ruby-value">0</span>

  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_iter-source -->
          
        </div>

        

        
      </div><!-- new_iter-method -->

    
      <div id="method-i-new_masgn" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_masgn</span><span
            class="method-args">(lhs, rhs, wrap = false)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_masgn-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 722</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_masgn</span> <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span>, <span class="ruby-identifier">wrap</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">value_expr</span>(<span class="ruby-identifier">rhs</span>)
  <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">lhs</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">?</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:to_ary</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-operator">:</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:array</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">wrap</span>

  <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">delete_at</span> <span class="ruby-value">1</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lhs</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">nil?</span>
  <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rhs</span>

  <span class="ruby-identifier">lhs</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_masgn-source -->
          
        </div>

        

        
      </div><!-- new_masgn-method -->

    
      <div id="method-i-new_module" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_module</span><span
            class="method-args">(val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_module-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 732</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_module</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">line</span>, <span class="ruby-identifier">path</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">4</span>]

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:module</span>, <span class="ruby-identifier">path</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span> <span class="ruby-comment"># REFACTOR?</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(*<span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">comments</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">pop</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_module-source -->
          
        </div>

        

        
      </div><!-- new_module-method -->

    
      <div id="method-i-new_op_asgn" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_op_asgn</span><span
            class="method-args">(val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_op_asgn-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 750</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_op_asgn</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">asgn_op</span>, <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">0</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>].<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
  <span class="ruby-identifier">name</span> = <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">value</span>
  <span class="ruby-identifier">arg</span> = <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">arg</span>)
  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">case</span> <span class="ruby-identifier">asgn_op</span> <span class="ruby-comment"># REFACTOR</span>
           <span class="ruby-keyword">when</span> <span class="ruby-value">:&quot;||&quot;</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:op_asgn_or</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">name</span>), <span class="ruby-identifier">lhs</span>)
           <span class="ruby-keyword">when</span> <span class="ruby-value">:&quot;&amp;&amp;&quot;</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">arg</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-value">:op_asgn_and</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">name</span>), <span class="ruby-identifier">lhs</span>)
           <span class="ruby-keyword">else</span>
             <span class="ruby-comment"># TODO: why [2] ?</span>
             <span class="ruby-identifier">lhs</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">new_call</span>(<span class="ruby-keyword">self</span>.<span class="ruby-identifier">gettable</span>(<span class="ruby-identifier">name</span>), <span class="ruby-identifier">asgn_op</span>, <span class="ruby-identifier">argl</span>(<span class="ruby-identifier">arg</span>))
             <span class="ruby-identifier">lhs</span>
           <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_op_asgn-source -->
          
        </div>

        

        
      </div><!-- new_op_asgn-method -->

    
      <div id="method-i-new_regexp" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_regexp</span><span
            class="method-args">(val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_regexp-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 770</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_regexp</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">node</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">1</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:str</span>, <span class="ruby-string">''</span>)
  <span class="ruby-identifier">options</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]

  <span class="ruby-identifier">o</span>, <span class="ruby-identifier">k</span> = <span class="ruby-value">0</span>, <span class="ruby-keyword">nil</span>
  <span class="ruby-identifier">options</span>.<span class="ruby-identifier">split</span>(<span class="ruby-regexp">//</span>).<span class="ruby-identifier">uniq</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-comment"># FIX: this has a better home</span>
    <span class="ruby-identifier">v</span> = {
      <span class="ruby-string">'x'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">EXTENDED</span>,
      <span class="ruby-string">'i'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">IGNORECASE</span>,
      <span class="ruby-string">'m'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">MULTILINE</span>,
      <span class="ruby-string">'o'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ONCE</span>,
      <span class="ruby-string">'n'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_NONE</span>,
      <span class="ruby-string">'e'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_EUC</span>,
      <span class="ruby-string">'s'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_SJIS</span>,
      <span class="ruby-string">'u'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_UTF8</span>,
    }[<span class="ruby-identifier">c</span>]
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unknown regexp option: #{c}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">v</span>
    <span class="ruby-identifier">o</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">v</span>
    <span class="ruby-identifier">k</span> = <span class="ruby-identifier">c</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">c</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/[esu]/</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>]
  <span class="ruby-keyword">when</span> <span class="ruby-value">:str</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:lit</span>
    <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>] = <span class="ruby-keyword">if</span> <span class="ruby-identifier">k</span> <span class="ruby-keyword">then</span>
                <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">o</span>, <span class="ruby-identifier">k</span>)
              <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">begin</span>
                  <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-identifier">o</span>)
                <span class="ruby-keyword">rescue</span> <span class="ruby-constant">RegexpError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
                  <span class="ruby-identifier">warn</span> <span class="ruby-node">&quot;Ignoring: #{e.message}&quot;</span>
                  <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>], <span class="ruby-constant">Regexp</span><span class="ruby-operator">::</span><span class="ruby-constant">ENC_NONE</span>)
                <span class="ruby-keyword">end</span>
              <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:dstr</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/o/</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dregx_once</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dregx</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">node</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:dregx</span>, <span class="ruby-string">''</span>, <span class="ruby-identifier">node</span>);
    <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dregx_once</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp">/o/</span>
    <span class="ruby-identifier">node</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">o</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">o</span> <span class="ruby-operator">!=</span> <span class="ruby-value">0</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">node</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_regexp-source -->
          
        </div>

        

        
      </div><!-- new_regexp-method -->

    
      <div id="method-i-new_resbody" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_resbody</span><span
            class="method-args">(cond, body)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_resbody-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 820</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_resbody</span> <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">body</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">body</span>.<span class="ruby-identifier">shift</span> <span class="ruby-comment"># remove block and splat it in directly</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">body</span> = [<span class="ruby-identifier">body</span>]
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">s</span>(<span class="ruby-value">:resbody</span>, <span class="ruby-identifier">cond</span>, *<span class="ruby-identifier">body</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_resbody-source -->
          
        </div>

        

        
      </div><!-- new_resbody-method -->

    
      <div id="method-i-new_sclass" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_sclass</span><span
            class="method-args">(val)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_sclass-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 829</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_sclass</span> <span class="ruby-identifier">val</span>
  <span class="ruby-identifier">recv</span>, <span class="ruby-identifier">in_def</span>, <span class="ruby-identifier">in_single</span>, <span class="ruby-identifier">body</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">3</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">4</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">6</span>], <span class="ruby-identifier">val</span>[<span class="ruby-value">7</span>]

  <span class="ruby-identifier">result</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:sclass</span>, <span class="ruby-identifier">recv</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">body</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block</span> <span class="ruby-keyword">then</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span>(*<span class="ruby-identifier">body</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">result</span>.<span class="ruby-identifier">push</span> <span class="ruby-identifier">body</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">val</span>[<span class="ruby-value">2</span>]
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_def</span> = <span class="ruby-identifier">in_def</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_single</span> = <span class="ruby-identifier">in_single</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_sclass-source -->
          
        </div>

        

        
      </div><!-- new_sclass-method -->

    
      <div id="method-i-new_super" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_super</span><span
            class="method-args">(args)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_super-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 848</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_super</span> <span class="ruby-identifier">args</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:super</span>, <span class="ruby-identifier">args</span>)
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:super</span>, *<span class="ruby-identifier">args</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_super-source -->
          
        </div>

        

        
      </div><!-- new_super-method -->

    
      <div id="method-i-new_undef" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_undef</span><span
            class="method-args">(n, m = nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_undef-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 857</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_undef</span> <span class="ruby-identifier">n</span>, <span class="ruby-identifier">m</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">m</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">block_append</span>(<span class="ruby-identifier">n</span>, <span class="ruby-identifier">s</span>(<span class="ruby-value">:undef</span>, <span class="ruby-identifier">m</span>))
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:undef</span>, <span class="ruby-identifier">n</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_undef-source -->
          
        </div>

        

        
      </div><!-- new_undef-method -->

    
      <div id="method-i-new_until" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_until</span><span
            class="method-args">(block, expr, pre)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_until-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 865</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_until</span> <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
  <span class="ruby-identifier">new_until_or_while</span> <span class="ruby-value">:until</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_until-source -->
          
        </div>

        

        
      </div><!-- new_until-method -->

    
      <div id="method-i-new_until_or_while" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_until_or_while</span><span
            class="method-args">(type, block, expr, pre)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_until_or_while-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 869</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_until_or_while</span> <span class="ruby-identifier">type</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
  <span class="ruby-identifier">other</span> = <span class="ruby-identifier">type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:until</span> <span class="ruby-operator">?</span> <span class="ruby-value">:while</span> <span class="ruby-operator">:</span> <span class="ruby-value">:until</span>
  <span class="ruby-identifier">line</span> = [<span class="ruby-identifier">block</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">block</span>.<span class="ruby-identifier">line</span>, <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">line</span>].<span class="ruby-identifier">compact</span>.<span class="ruby-identifier">min</span>
  <span class="ruby-identifier">block</span>, <span class="ruby-identifier">pre</span> = <span class="ruby-identifier">block</span>.<span class="ruby-identifier">last</span>, <span class="ruby-keyword">false</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">block</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">block</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:begin</span>

  <span class="ruby-identifier">expr</span> = <span class="ruby-identifier">cond</span> <span class="ruby-identifier">expr</span>

  <span class="ruby-identifier">result</span> = <span class="ruby-keyword">unless</span> <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:not</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">canonicalize_conditions</span> <span class="ruby-keyword">then</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-identifier">type</span>,  <span class="ruby-identifier">expr</span>,      <span class="ruby-identifier">block</span>, <span class="ruby-identifier">pre</span>)
           <span class="ruby-keyword">else</span>
             <span class="ruby-identifier">s</span>(<span class="ruby-identifier">other</span>, <span class="ruby-identifier">expr</span>.<span class="ruby-identifier">last</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">pre</span>)
           <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">line</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_until_or_while-source -->
          
        </div>

        

        
      </div><!-- new_until_or_while-method -->

    
      <div id="method-i-new_when" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_when</span><span
            class="method-args">(cond, body)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_when-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 886</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_when</span> <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">body</span>
  <span class="ruby-identifier">s</span>(<span class="ruby-value">:when</span>, <span class="ruby-identifier">cond</span>, <span class="ruby-identifier">body</span>)
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_when-source -->
          
        </div>

        

        
      </div><!-- new_when-method -->

    
      <div id="method-i-new_while" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_while</span><span
            class="method-args">(block, expr, pre)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_while-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 890</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_while</span> <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
  <span class="ruby-identifier">new_until_or_while</span> <span class="ruby-value">:while</span>, <span class="ruby-identifier">block</span>, <span class="ruby-identifier">expr</span>, <span class="ruby-identifier">pre</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_while-source -->
          
        </div>

        

        
      </div><!-- new_while-method -->

    
      <div id="method-i-new_xstring" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_xstring</span><span
            class="method-args">(str)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_xstring-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 894</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_xstring</span> <span class="ruby-identifier">str</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">str</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">case</span> <span class="ruby-identifier">str</span>[<span class="ruby-value">0</span>]
    <span class="ruby-keyword">when</span> <span class="ruby-value">:str</span>
      <span class="ruby-identifier">str</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:xstr</span>
    <span class="ruby-keyword">when</span> <span class="ruby-value">:dstr</span>
      <span class="ruby-identifier">str</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:dxstr</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-identifier">str</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:dxstr</span>, <span class="ruby-string">''</span>, <span class="ruby-identifier">str</span>)
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">str</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">s</span>(<span class="ruby-value">:xstr</span>, <span class="ruby-string">''</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_xstring-source -->
          
        </div>

        

        
      </div><!-- new_xstring-method -->

    
      <div id="method-i-new_yield" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">new_yield</span><span
            class="method-args">(args = nil)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="new_yield-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 910</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">new_yield</span> <span class="ruby-identifier">args</span> = <span class="ruby-keyword">nil</span>
  <span class="ruby-comment"># TODO: raise args.inspect unless [:arglist].include? args.first # HACK</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 4&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">args</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;Block argument should not be given.&quot;</span> <span class="ruby-keyword">if</span>
    <span class="ruby-identifier">args</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">node_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>

  <span class="ruby-identifier">args</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>)

  <span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:arglist</span> <span class="ruby-keyword">if</span> [<span class="ruby-value">:call_args</span>, <span class="ruby-value">:array</span>].<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">args</span>[<span class="ruby-value">0</span>])
  <span class="ruby-identifier">args</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:arglist</span>, <span class="ruby-identifier">args</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">args</span>.<span class="ruby-identifier">first</span> <span class="ruby-operator">==</span> <span class="ruby-value">:arglist</span>

  <span class="ruby-keyword">return</span> <span class="ruby-identifier">s</span>(<span class="ruby-value">:yield</span>, *<span class="ruby-identifier">args</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>])
<span class="ruby-keyword">end</span></pre>
          </div><!-- new_yield-source -->
          
        </div>

        

        
      </div><!-- new_yield-method -->

    
      <div id="method-i-next_token" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">next_token</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="next_token-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 924</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">next_token</span>
  <span class="ruby-keyword">if</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">advance</span> <span class="ruby-keyword">then</span>
    <span class="ruby-keyword">return</span> <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">token</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">yacc_value</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-keyword">return</span> [<span class="ruby-keyword">false</span>, <span class="ruby-string">'$end'</span>]
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- next_token-source -->
          
        </div>

        

        
      </div><!-- next_token-method -->

    
      <div id="method-i-node_assign" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">node_assign</span><span
            class="method-args">(lhs, rhs)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="node_assign-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 932</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">node_assign</span>(<span class="ruby-identifier">lhs</span>, <span class="ruby-identifier">rhs</span>) <span class="ruby-comment"># TODO: rename new_assign</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">lhs</span>

  <span class="ruby-identifier">rhs</span> = <span class="ruby-identifier">value_expr</span> <span class="ruby-identifier">rhs</span>

  <span class="ruby-keyword">case</span> <span class="ruby-identifier">lhs</span>[<span class="ruby-value">0</span>]
  <span class="ruby-keyword">when</span> <span class="ruby-value">:gasgn</span>, <span class="ruby-value">:iasgn</span>, <span class="ruby-value">:lasgn</span>, <span class="ruby-value">:masgn</span>, <span class="ruby-value">:cdecl</span>, <span class="ruby-value">:cvdecl</span>, <span class="ruby-value">:cvasgn</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rhs</span>
  <span class="ruby-keyword">when</span> <span class="ruby-value">:attrasgn</span>, <span class="ruby-value">:call</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">args</span> = <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">pop</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">Symbol</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">last</span>
    <span class="ruby-identifier">lhs</span>.<span class="ruby-identifier">concat</span> <span class="ruby-identifier">arg_add</span>(<span class="ruby-identifier">args</span>, <span class="ruby-identifier">rhs</span>)[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>]
  <span class="ruby-keyword">when</span> <span class="ruby-value">:const</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">lhs</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:cdecl</span>
    <span class="ruby-identifier">lhs</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">rhs</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;unknown lhs #{lhs.inspect}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">lhs</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- node_assign-source -->
          
        </div>

        

        
      </div><!-- node_assign-method -->

    
      <div id="method-i-on_error" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">on_error</span><span
            class="method-args">(et, ev, values)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="on_error-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1116</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">on_error</span>(<span class="ruby-identifier">et</span>, <span class="ruby-identifier">ev</span>, <span class="ruby-identifier">values</span>)
  <span class="ruby-keyword">super</span>
<span class="ruby-keyword">rescue</span> <span class="ruby-constant">Racc</span><span class="ruby-operator">::</span><span class="ruby-constant">ParseError</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
  <span class="ruby-comment"># I don't like how the exception obscures the error message</span>
  <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>.<span class="ruby-identifier">replace</span> <span class="ruby-string">&quot;%s:%p :: %s&quot;</span> <span class="ruby-operator">%</span> [<span class="ruby-keyword">self</span>.<span class="ruby-identifier">file</span>, <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">lineno</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>.<span class="ruby-identifier">strip</span>]
  <span class="ruby-identifier">warn</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">$DEBUG</span>
  <span class="ruby-identifier">raise</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- on_error-source -->
          
        </div>

        

        
      </div><!-- on_error-method -->

    
      <div id="method-i-process" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">process</span><span
            class="method-args">(str, file = "(string)", time = 10)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          <p>Parse <code>str</code> at path <code>file</code> and return a sexp. Raises
Timeout::Error if it runs for more than <code>time</code> seconds.</p>
          

          
          <div class="method-source-code" id="process-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1030</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">process</span>(<span class="ruby-identifier">str</span>, <span class="ruby-identifier">file</span> = <span class="ruby-string">&quot;(string)&quot;</span>, <span class="ruby-identifier">time</span> = <span class="ruby-value">10</span>)
  <span class="ruby-constant">Timeout</span>.<span class="ruby-identifier">timeout</span> <span class="ruby-identifier">time</span> <span class="ruby-keyword">do</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-node">&quot;bad val: #{str.inspect}&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-constant">String</span> <span class="ruby-operator">===</span> <span class="ruby-identifier">str</span>

    <span class="ruby-identifier">str</span> = <span class="ruby-identifier">handle_encoding</span> <span class="ruby-identifier">str</span>

    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">file</span> = <span class="ruby-identifier">file</span>.<span class="ruby-identifier">dup</span>
    <span class="ruby-keyword">self</span>.<span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">src</span> = <span class="ruby-identifier">str</span>

    <span class="ruby-ivar">@yydebug</span> = <span class="ruby-constant">ENV</span>.<span class="ruby-identifier">has_key?</span> <span class="ruby-string">'DEBUG'</span>

    <span class="ruby-identifier">do_parse</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- process-source -->
          
        </div>

        

        
      </div><!-- process-method -->

    
      <div id="method-i-remove_begin" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">remove_begin</span><span
            class="method-args">(node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="remove_begin-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1047</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">remove_begin</span> <span class="ruby-identifier">node</span>
  <span class="ruby-identifier">oldnode</span> = <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">and</span> <span class="ruby-value">:begin</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-keyword">and</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">node</span> = <span class="ruby-identifier">node</span>[<span class="ruby-value">-1</span>]
    <span class="ruby-identifier">node</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">oldnode</span>.<span class="ruby-identifier">line</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">node</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- remove_begin-source -->
          
        </div>

        

        
      </div><!-- remove_begin-method -->

    
      <div id="method-i-reset" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reset</span><span
            class="method-args">()</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="reset-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1056</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">reset</span>
  <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">reset</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_def</span> = <span class="ruby-keyword">false</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">in_single</span> = <span class="ruby-value">0</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">env</span>.<span class="ruby-identifier">reset</span>
  <span class="ruby-keyword">self</span>.<span class="ruby-identifier">comments</span>.<span class="ruby-identifier">clear</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- reset-source -->
          
        </div>

        

        
      </div><!-- reset-method -->

    
      <div id="method-i-ret_args" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">ret_args</span><span
            class="method-args">(node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="ret_args-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1069</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">ret_args</span> <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;write a test 5&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>

    <span class="ruby-identifier">raise</span> <span class="ruby-constant">SyntaxError</span>, <span class="ruby-string">&quot;block argument should not be given&quot;</span> <span class="ruby-keyword">if</span>
      <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:block_pass</span>

    <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:array</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:call_args</span>
    <span class="ruby-identifier">node</span> = <span class="ruby-identifier">node</span>.<span class="ruby-identifier">last</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:array</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">==</span> <span class="ruby-value">2</span>

    <span class="ruby-comment"># HACK matz wraps ONE of the FOUR splats in a newline to</span>
    <span class="ruby-comment"># distinguish. I use paren for now. ugh</span>
    <span class="ruby-identifier">node</span> = <span class="ruby-identifier">s</span>(<span class="ruby-value">:svalue</span>, <span class="ruby-identifier">node</span>) <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:splat</span> <span class="ruby-keyword">and</span> <span class="ruby-keyword">not</span> <span class="ruby-identifier">node</span>.<span class="ruby-identifier">paren</span>
    <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] = <span class="ruby-value">:svalue</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:arglist</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span>][<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:splat</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">node</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- ret_args-source -->
          
        </div>

        

        
      </div><!-- ret_args-method -->

    
      <div id="method-i-s" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">s</span><span
            class="method-args">(*args)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="s-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1088</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">s</span>(*<span class="ruby-identifier">args</span>)
  <span class="ruby-identifier">result</span> = <span class="ruby-constant">Sexp</span>.<span class="ruby-identifier">new</span>(*<span class="ruby-identifier">args</span>)
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">line</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">lineno</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">lexer</span>.<span class="ruby-identifier">src</span>          <span class="ruby-comment"># otherwise...</span>
  <span class="ruby-identifier">result</span>.<span class="ruby-identifier">file</span> = <span class="ruby-keyword">self</span>.<span class="ruby-identifier">file</span>
  <span class="ruby-identifier">result</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- s-source -->
          
        </div>

        

        
      </div><!-- s-method -->

    
      <div id="method-i-syntax_error" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">syntax_error</span><span
            class="method-args">(msg)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="syntax_error-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 146</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">syntax_error</span> <span class="ruby-identifier">msg</span>
  <span class="ruby-identifier">raise</span> <span class="ruby-constant">RubyParser</span><span class="ruby-operator">::</span><span class="ruby-constant">SyntaxError</span>, <span class="ruby-identifier">msg</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- syntax_error-source -->
          
        </div>

        

        
      </div><!-- syntax_error-method -->

    
      <div id="method-i-value_expr" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">value_expr</span><span
            class="method-args">(oldnode)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="value_expr-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1095</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">value_expr</span> <span class="ruby-identifier">oldnode</span> <span class="ruby-comment"># HACK</span>
  <span class="ruby-identifier">node</span> = <span class="ruby-identifier">remove_begin</span> <span class="ruby-identifier">oldnode</span>
  <span class="ruby-identifier">node</span>.<span class="ruby-identifier">line</span> = <span class="ruby-identifier">oldnode</span>.<span class="ruby-identifier">line</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">oldnode</span>
  <span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>] = <span class="ruby-identifier">value_expr</span>(<span class="ruby-identifier">node</span>[<span class="ruby-value">2</span>]) <span class="ruby-keyword">if</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">and</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:if</span>
  <span class="ruby-identifier">node</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- value_expr-source -->
          
        </div>

        

        
      </div><!-- value_expr-method -->

    
      <div id="method-i-void_stmts" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">void_stmts</span><span
            class="method-args">(node)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="void_stmts-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1102</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">void_stmts</span> <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">nil</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">node</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">node</span>[<span class="ruby-value">0</span>] <span class="ruby-operator">==</span> <span class="ruby-value">:block</span>

  <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>] = <span class="ruby-identifier">node</span>[<span class="ruby-value">1</span><span class="ruby-operator">..</span><span class="ruby-value">-1</span>].<span class="ruby-identifier">map</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">n</span><span class="ruby-operator">|</span> <span class="ruby-identifier">remove_begin</span>(<span class="ruby-identifier">n</span>) }
  <span class="ruby-identifier">node</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- void_stmts-source -->
          
        </div>

        

        
      </div><!-- void_stmts-method -->

    
      <div id="method-i-warning" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">warning</span><span
            class="method-args">(s)</span>
          <span class="method-click-advice">click to toggle source</span>
        </div>
        

        <div class="method-description">
          
          
          

          
          <div class="method-source-code" id="warning-source">
            <pre><span class="ruby-comment"># File lib/ruby_parser_extras.rb, line 1110</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">warning</span> <span class="ruby-identifier">s</span>
  <span class="ruby-comment"># do nothing for now</span>
<span class="ruby-keyword">end</span></pre>
          </div><!-- warning-source -->
          
        </div>

        

        
      </div><!-- warning-method -->

    
    </section><!-- public-instance-method-details -->
  
  </section><!-- 5Buntitled-5D -->

</div><!-- documentation -->


<footer id="validator-badges">
  <p><a href="http://validator.w3.org/check/referer">[Validate]</a>
  <p>Generated by <a href="https://github.com/rdoc/rdoc">RDoc</a> 3.12.2.
  <p>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish Rdoc Generator</a> 3.
</footer>

